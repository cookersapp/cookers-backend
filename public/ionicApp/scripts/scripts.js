angular.module("app",["ionic","ionic.contrib.ui.cards","ngSanitize","ngAnimate","ngTouch","ngCordova","firebase","angular-md5","monospaced.elastic"]).config(["$stateProvider","$urlRouterProvider","$provide",function(a,b,c){"use strict";c.decorator("$exceptionHandler",["$delegate",function(a){return function(b,c){a(b,c);var d={type:"angular"};c&&(d.cause=c),b&&(b.message&&(d.message=b.message),b.name&&(d.name=b.name),b.stack&&(d.stack=b.stack)),Logger.track("exception",d)}}]),a.state("app",{url:"/app","abstract":!0,templateUrl:"views/sidemenu.html",controller:"AppCtrl",data:{restrict:"connected"}}).state("app.home",{url:"/home",views:{menuContent:{templateUrl:"views/home.html",controller:"HomeCtrl"}},data:{restrict:"connected"}});var d=JSON.parse(localStorage.getItem("ionic-user"));b.otherwise(d&&d.skipIntro?d.isLogged?"/app/home":"/login":"/intro")}]).constant("debug",Config.debug).constant("appVersion",Config.appVersion).constant("firebaseUrl","https://crackling-fire-7710.firebaseio.com").constant("mandrillUrl","https://mandrillapp.com/api/1.0").constant("mandrillKey","__YzrUYwZGkqqSM2pe9XFg").constant("supportTeamEmail","loicknuchel@gmail.com").constant("$ionicLoadingConfig",{template:'<loading color="rgba(255,255,255,0.7)"></loading>',noBackdrop:!0}).value("localStorageDefault",{app:{version:"",firstLaunch:Date.now()},user:{skipIntro:!1,isLogged:!1,loggedWith:null,email:"",name:"Anonymous",avatar:"images/user.jpg",background:"#6f5499",backgroundCover:"images/profile-covers/cover01.jpg",firstName:"",lastName:"",more:{},device:{},settings:{defaultServings:2,showPrices:!1,bigImages:!0},data:{skipCookFeatures:!1,skipCartFeatures:!1,welcomeMailSent:!1}},userSocialProfiles:{},userCarts:{carts:[]},userStandaloneCookedRecipes:{recipes:[]},userRecipeHistory:{recipes:[]},dataFoods:{foods:{}},dataRecipes:{recipes:{}},dataSelections:{selections:{}},dataGlobalmessages:{lastCall:null,messages:[]}}).run(["$rootScope","$location","$ionicPlatform","LaunchSrv","StorageSrv","appVersion","debug",function(a,b,c,d,e,f,g){"use strict";e.init(),a.ctx={settings:e.getUser().settings,debug:g,appVersion:f},c.ready(function(){d.launch()}),a.isActive=function(a){var c=new RegExp("^"+a+"$","g");return c.test(b.path())},a.safeApply=function(a){var b=this.$root?this.$root.$$phase:this.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}]),angular.module("app").filter("date",function(){"use strict";return function(a,b){return a?moment(a).format(b?b:"ll"):"<date>"}}).filter("duration",["$filter",function(){"use strict";return function(a,b){if(a||0===a){if(b)return moment.duration(a,"seconds").humanize();var c=a>-60&&60>a?"00:":"";return c+moment.duration(a,"seconds").format("hh:mm:ss")}return console.warn("Unable to format duration",a),"<duration>"}}]).filter("mynumber",["$filter",function(a){"use strict";return function(b,c){var d=Math.pow(10,c?c:0);return a("number")(Math.round(b*d)/d)}}]).filter("unit",function(){"use strict";return function(a){return"piece"===a||"pièce"===a?"":a}}).filter("cookTime",["$filter",function(a){"use strict";return function(b){return b&&b.eat>0?a("mynumber")(b.eat,2)+" "+a("unit")(b.unit):""}}]).filter("servings",["$filter",function(a){"use strict";return function(b,c){return c||(c=1),b&&b.value>0?a("mynumber")(b.value*c,2)+" "+a("unit")(b.unit):""}}]).filter("price",["$filter",function(a){"use strict";return function(b,c,d){return b?(void 0===c&&(c=!0),void 0===d&&(d=1),a("mynumber")(b.value*d,2)+" "+b.currency+(c&&b.unit?"/"+b.unit:"")):"<price>"}}]).filter("quantity",["$filter",function(a){"use strict";return function(b,c){return c||(c=1),b&&b.value>0?a("mynumber")(b.value*c,2)+" "+a("unit")(b.unit):""}}]).filter("tool",function(){"use strict";return function(a){return a&&a.name?a.name:""}}).filter("ingredient",["$filter",function(a){"use strict";function b(a,b){return-1!==a.indexOf(b,a.length-b.length)}function c(a){return a&&a.pre?" "+a.pre+(b(a.pre,"'")?"":" "):" "}function d(a){return a&&a.post?" "+a.post:""}return function(b,e){return b?a("quantity")(b.quantity,e)+c(b)+b.food.name+d(b):""}}]),angular.module("app").factory("GlobalMessageSrv",["$q","StorageSrv","BackendSrv","debug","appVersion",function($q,StorageSrv,BackendSrv,debug,appVersion){"use strict";function getStandardMessageToDisplay(){var a="standard",b=findMessage(a);return b?(fetchMessages(),$q.when(b)):fetchMessages().then(function(){return findMessage(a)})}function getStickyMessages(){var a="sticky";return fetchMessages().then(function(){return findMessages(a)})}function execMessages(){var a="exec";return fetchMessages().then(function(){var b=findMessages(a);for(var c in b)b[c].exec&&execMessage(b[c].exec,b[c]),b[c].hide=!0;return b})}function findMessages(a){return _.filter(StorageSrv.getGlobalMessages().messages,function(b){return b.type===a&&!b.hide&&b.shouldDisplay&&execMessage(b.shouldDisplay,b)})}function findMessage(a){return _.find(StorageSrv.getGlobalMessages().messages,function(b){return b.type===a&&!b.hide&&b.shouldDisplay&&execMessage(b.shouldDisplay,b)})}function fetchMessages(){return StorageSrv.getGlobalMessages().lastCall=Date.now(),BackendSrv.getMessages().then(function(a){var b=_.filter(a,function(a){return a&&(a.isProd||debug)&&a.targets&&a.targets.indexOf(appVersion)>-1&&!messageExists(a)});StorageSrv.getGlobalMessages().messages=StorageSrv.getGlobalMessages().messages.concat(b),StorageSrv.getGlobalMessages().messages.sort(function(a,b){return a.created-b.created})})}function execMessage(fn,message){var user=StorageSrv.getUser();return eval(fn)}function messageExists(a){return a&&a.created&&_.findIndex(StorageSrv.getGlobalMessages().messages,{created:a.created})>-1}var service={getStandardMessageToDisplay:getStandardMessageToDisplay,getStickyMessages:getStickyMessages,execMessages:execMessages};return service}]).factory("EmailSrv",["$http","$q","mandrillUrl","mandrillKey","supportTeamEmail",function(a,b,c,d,e){"use strict";function f(b,f){return a.post(c+"/messages/send.json",{key:d,message:{subject:"[Cookers] Feedback from app",text:f,from_email:b,to:[{email:e,name:"Cookers team"}],important:!1,track_opens:!0,track_clicks:null,preserve_recipients:null,tags:["app","feedback"]},async:!1}).then(function(a){var b=!0;for(var c in a.data)a.data[c].reject_reason&&(b=!1);return b})}function g(b,e){return a.post(c+"/messages/send-template.json",{key:d,template_name:"welcome",template_content:[],message:{to:[{email:e}],track_opens:!0,preserve_recipients:!0,global_merge_vars:[{name:"FNAME",content:b}],tags:["app","welcome"]}})}var h={sendFeedback:f,sendWelcome:g};return h}]),angular.module("app").directive("blurOnKeyboardOut",["$window",function(a){"use strict";return{restrict:"A",link:function(b,c,d){a.addEventListener("native.keyboardhide",function(){c[0].blur(),b.safeApply(function(){b.$eval(d.blurOnKeyboardOut)})})}}}]).directive("focusOnKeyboardOpen",["$window",function(a){"use strict";return{restrict:"A",link:function(b,c){var d=!1;a.addEventListener("native.keyboardshow",function(){d=!0,c[0].focus()}),a.addEventListener("native.keyboardhide",function(){d=!1,c[0].blur()}),c[0].addEventListener("blur",function(){d&&c[0].focus()},!0)}}}]).directive("externalContent",["$compile",function(a){"use strict";return{restrict:"A",scope:{html:"=externalContent"},link:function(b,c){b.$watch("html",function(){c.html(""),c.append(a("<span>"+b.html+"</span>")(b))})}}}]).directive("href",["$window",function(a){"use strict";return{restrict:"A",scope:{url:"@href"},link:function(b,c){(0===b.url.indexOf("http://")||0===b.url.indexOf("https://"))&&c.bind("click",function(c){c.preventDefault(),a.open(encodeURI(b.url),"_system","location=yes")})}}}]).directive("loading",function(){"use strict";return{restrict:"E",scope:{color:"@"},template:'<div class="spinner"><div class="dot1" ng-style="style"></div><div class="dot2" ng-style="style"></div></div>',link:function(a){a.style=a.color?{"background-color":a.color}:{}}}}),angular.module("app").controller("AppCtrl",["$scope","$interval","$ionicPlatform","$ionicSideMenuDelegate","StorageSrv",function(a,b,c,d,e){"use strict";c.ready(function(){a.defaultCovers=["images/sidemenu-covers/cover1.jpg","images/sidemenu-covers/cover2.jpg","images/sidemenu-covers/cover3.jpg","images/sidemenu-covers/cover4.png","images/sidemenu-covers/cover5.jpg","images/sidemenu-covers/cover6.jpg"],a.imageCover=a.defaultCovers[0],a.user=e.getUser(),b(function(){var b=e.getRecipeHistory(),c=b?b.length:0;a.imageCover=c>0&&Math.random()>c/a.defaultCovers.length?b[Math.floor(Math.random()*c)].images.landing:a.defaultCovers[Math.floor(Math.random()*a.defaultCovers.length)]},1e4)})}]).controller("HomeCtrl",["$scope","$timeout","GlobalMessageSrv","StorageSrv","EmailSrv","LogSrv","Utils",function(a,b,c,d,e,f,g){"use strict";a.standardMessage=null,a.stickyMessages=[];var h=d.getUser();if(h.email&&g.isEmail(h.email)&&!h.data.welcomeMailSent){var i="";h.firstName?i=h.firstName:h.name&&"Anonymous"!==h.name&&(i=h.name),e.sendWelcome(i,h.email).then(function(){d.saveUserData("welcomeMailSent",!0)})}c.getStandardMessageToDisplay().then(function(b){a.standardMessage=b}),c.getStickyMessages().then(function(b){a.stickyMessages=b}),c.execMessages(),a.hideStandardMessage=function(){f.trackHideMessage(a.standardMessage.id),a.standardMessage.hide=!0,a.standardMessage=null,b(function(){c.getStandardMessageToDisplay().then(function(b){a.standardMessage=b})},3e3)}}]),angular.module("app").factory("Utils",["$window","$interval",function(a,b){"use strict";function c(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return(a()+a()+"-"+a()+"-4"+a().substr(0,3)+"-"+a()+"-"+a()+a()+a()).toLowerCase()}function d(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,c){a[c]&&"object"==typeof a[c]?d(a[c],b):a[c]=angular.copy(b)})}),a}function e(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}function f(a,b){return-1!==a.indexOf(b,a.length-b.length)}function g(a){var b={id:p++,fn:a};return n.push(b),1===n.length&&i(),b.id}function h(a){for(var b in n)n[b].id===a&&n.splice(b,1);0===n.length&&j()}function i(){null===o&&(o=b(function(){for(var a in n)n[a].fn()},1e3))}function j(){null!==o&&(b.cancel(o),o=null)}function k(){var a=angular.copy(ionic.Platform.device());return delete a.getInfo,a.environment=l(),a.grade=ionic.Platform.grade,a.platforms=ionic.Platform.platforms,a.uuid||(a.uuid=c()),a}function l(){return ionic.Platform.isWebView()?"WebView":ionic.Platform.isIPad()?"IPad":ionic.Platform.isIOS()?"IOS":ionic.Platform.isAndroid()?"Android":ionic.Platform.isWindowsPhone()?"WindowsPhone":"Unknown"}var m={createUuid:c,extendDeep:d,isEmail:e,endsWith:f,clock:g,cancelClock:h,getDevice:k},n=[],o=null,p=0;return m}]).factory("MediaSrv",["$q","$ionicPlatform","$window","LogSrv",function(a,b,c,d){"use strict";function e(d,e,g,h){var i=a.defer();return b.ready(function(){var a=function(){e&&e()},j=function(a){f(d,a),g&&g(a)},k=function(a){h&&h(a)};b.is("android")&&(d="/android_asset/www/"+d),i.resolve(new c.Media(d,a,j,k))}),i.promise}function f(a,b){d.trackError("media",{src:a,code:b.code,message:h(b.code)})}function g(a){return 0===a?"Media.MEDIA_NONE":1===a?"Media.MEDIA_STARTING":2===a?"Media.MEDIA_RUNNING":3===a?"Media.MEDIA_PAUSED":4===a?"Media.MEDIA_STOPPED":"Unknown status <"+a+">"}function h(a){return 1===a?"MediaError.MEDIA_ERR_ABORTED":2===a?"MediaError.MEDIA_ERR_NETWORK":3===a?"MediaError.MEDIA_ERR_DECODE":4===a?"MediaError.MEDIA_ERR_NONE_SUPPORTED":"Unknown code <"+a+">"}var i={loadMedia:e,getStatusMessage:g,getErrorMessage:h,loadTimerAlarm:function(a,b,c){return e("sounds/timerEnds.mp3",a,b,c)}};return i}]).factory("PopupSrv",["$rootScope","$q","$ionicPopup","$ionicActionSheet","$window",function(a,b,c,d,e){"use strict";function f(){var b=a.$new(!0);return b.data={email:"",shouldInsist:!0},c.show({title:'<i class="fa fa-smile-o"></i> Lâche ton mail &nbsp;<i class="fa fa-smile-o"></i>',subTitle:"!! No spam guaranteed !!",template:'<input type="email" placeholder="ex: nom@example.com" ng-model="data.email" required>',scope:b,buttons:[{text:"Non !",onTap:function(a){return b.data.shouldInsist?(e.plugins.toast.show("S'il-te-plaît ..."),b.data.shouldInsist=!1,a.preventDefault(),void 0):""}},{text:"<b>Voilà !</b>",type:"button-positive",onTap:function(a){return b.data.email?(e.plugins.toast.show("Merci :D"),b.data.email):void a.preventDefault()}}]})}function g(b,d){var e=a.$new(!0);return e.data={servings:b?b:2},c.show({template:['<div style="text-align: center;">'+(d?'<h3 class="title" style="font-size: 20px;">'+d+"</h3>":"")+'<div>Cuisiner pour <b ng-bind="data.servings">??</b> personnes ?</div></div><div class="range"><i class="fa fa-user"></i><input type="range" name="servings" min="1" max="10" ng-model="data.servings"><i class="fa fa-users"></i></div>'].join(""),scope:e,buttons:[{text:"Annuler"},{text:"<b>Ok</b>",type:"button-positive",onTap:function(){return e.data.servings}}]})}function h(){var a=b.defer();return d.show({titleText:"La recette est maintenant terminée ! Que faire ?",destructiveText:"Quitter l'application",destructiveButtonClicked:function(){a.resolve(!0)},cancelText:"Revenir à l'accueil",cancel:function(){a.resolve(!1)}}),a.promise}function i(){return c.show({title:"Man vs Time",subTitle:"Respecte le chrono !!!",template:['<ul style="list-style: circle;"><li style="margin: 0px 0 5px 15px;"><i>Ne brûle rien</i>, aide-toi des <b>timers</b></li><li style="margin: 0px 0 5px 15px;"><i>Ne perds pas ton temps</i> avec le téléphone, <b>l\'écran reste allumé</b></li><li style="margin: 0px 0 5px 15px;"><i>Valide ton chrono</i> en cliquant sur <b>Finir !</b></li></ul>'].join(""),buttons:[{text:"<b>Go !</b>",type:"button-custom"}]})}function j(){return c.show({title:"Liste de course",template:"<div class=\"text-align: center;\">Fais tes courses pépère,<br>l'écran ne s'éteint pas :D</div>",buttons:[{text:"<b>Ok</b>",type:"button-custom"}]})}var k={askMail:f,changeServings:g,recipeCooked:h,tourCookFeatures:i,tourCartFeatures:j};return k}]),angular.module("app").factory("IngredientUtils",["LogSrv",function(a){"use strict";function b(a,b){if(Array.isArray(a)&&a.length>0){var e=angular.copy(a[0]);b||(b={}),b.ingredient=e;for(var f=1;f<a.length;f++)e.quantity=c(e.quantity,a[f].quantity,b),e.price=d(e.price,a[f].price,b);return e}}function c(b,c,d,e){var f=angular.copy(b);if(f.unit===c.unit)f.value+=c.value;else{var g={message:"Can't add quantity <"+b.unit+"> with quantity <"+c.unit+">"+(d&&d.ingredient?" for ingredient <"+d.ingredient.food.name+">":"")+" !"};d&&d.ingredient&&(g.ingredient=angular.copy(d.ingredient)),e?e.push(g):a.trackError("addIngredientsQuantity",g)}return f}function d(b,c,d,e){var f=angular.copy(b);if(f.unit===c.unit)f.value+=c.value;else{var g={message:"Can't add price <"+b.unit+"> with price <"+c.unit+">"+(d&&d.ingredient?" for ingredient <"+d.ingredient.food.name+">":"")+" !"};d&&d.ingredient&&(g.ingredient=angular.copy(d.ingredient)),e?e.push(g):a.trackError("addIngredientsPrice",g)}return f}function e(b,c,d,e){var f=angular.copy(b);if(c.unit===d.unit)f.value=f.value*d.value/c.value;else{var g={message:"Quantity <"+b.unit+"> can't be converting from servings <"+c.unit+"> to servings <"+d.unit+"> !",quantity:angular.copy(b),initialServings:angular.copy(c),finalServings:angular.copy(d)};e?e.push(g):a.trackError("adjustForServings",g)}return f}var f={adjustForServings:e,sum:b};return f}]),angular.module("app").factory("LogSrv",["$timeout","$window","Utils","_LocalStorageSrv","appVersion",function(a,b,c,d,e){"use strict";function f(b,c){if(navigator&&navigator.geolocation){var d=a(function(){console.log("position timeout !"),g(b,c)},3e3);navigator.geolocation.getCurrentPosition(function(e){a.cancel(d),c.position=e.coords,c.position&&(c.position.timestamp=e.timestamp),g(b,c)},function(e){a.cancel(d),c.position=e,c.position&&(c.position.timestamp=Date.now()),g(b,c)},{enableHighAccuracy:!0,timeout:2e3,maximumAge:0})}else g(b,c)}function g(a,b){var c=d.getUser();b||(b={}),b.appVersion=e,!b.email&&c&&c.email&&(b.email=c.email),c&&c.device&&(!b.uuid&&c.device.uuid&&(b.uuid=c.device.uuid),!b.device&&c.device.model&&c.device.platform&&c.device.version&&(b.device={model:c.device.model,platform:c.device.platform,version:c.device.version})),Logger.track(a,b)}function h(){var a=d.getApp(),b=d.getUser(),f={};a.firstLaunch&&(f.$created=new Date(a.firstLaunch)),b.email&&c.isEmail(b.email)&&(f.$email=b.email),a.firstName&&(f.$first_name=a.firstName),a.lastName&&(f.$last_name=a.lastName),a.name&&(f.fullName=a.name),a.avatar&&(f.avatar=a.avatar),a.backgroundCover&&(f.backgroundCover=a.backgroundCover),e&&(f.appVersion=e),b.device&&(b.device.uuid&&(f["device.uuid"]=b.device.uuid),b.device.model&&(f["device.model"]=b.device.model),b.device.platform&&(f["device.platform"]=b.device.platform),b.device.version&&(f["device.version"]=b.device.version));for(var g in b.more)f["more."+g]=b.more[g];for(var h in b.settings)f["setting."+h]=b.settings[h];Logger.setProfile(f)}var i={identify:Logger.identify,registerUser:h,trackInstall:function(a){g("install",{user:a})},trackUpgrade:function(a,b){g("upgrade",{from:a,to:b})},trackLaunch:function(a,b){g("launch",{user:a,launchTime:b})},trackLogin:function(a,b){g("login",{provider:a,data:b})},trackIntroChangeSlide:function(a,b){g("intro-change-slide",{from:a,to:b})},trackIntroExit:function(a){g("intro-exit",{slide:a})},trackState:function(a){g("state",a)},trackStateError:function(a){g("state-error",a)},trackStateNotFound:function(a){g("state-not-found",a)},trackSetEmail:function(a){g("set-email",{email:a})},trackHideMessage:function(a){g("hide-message",{message:a})},trackRecipesFeedback:function(a,b){g("recipes-feedback",{week:a,feedback:b})},trackAddRecipeToCart:function(a,b,c,d){f("add-recipe-to-cart",{recipe:a,servings:b,index:c,from:d})},trackRemoveRecipeFromCart:function(a,b,c){f("remove-recipe-from-cart",{recipe:a,index:b,from:c})},trackEditCartCustomItems:function(a){g("edit-cart-custom-items",{customItems:a})},trackCartRecipeDetails:function(a,b){g("cart-recipe-details",{recipe:a,action:b})},trackCartItemDetails:function(a,b){g("cart-item-details",{item:a,action:b})},trackBuyItem:function(a){f("buy-item",{item:a})},trackUnbuyItem:function(a){g("unbuy-item",{item:a})},trackArchiveCart:function(){g("archive-cart")},trackRecipeCooked:function(a,b){g("recipe-cooked",{recipe:a,cookDuration:b})},trackSendFeedback:function(a){g("send-feedback",{email:a})},trackOpenUservoice:function(){g("open-uservoice")},trackChangeSetting:function(a,b){g("change-setting",{setting:a,value:b})},trackLogout:function(a){g("logout",{user:a})},trackClearCache:function(a){g("clear-cache",{user:a})},trackClearApp:function(a){g("clear-app",{user:a})},trackError:function(a,b){g("error",{type:a,error:b})}};return i}]),angular.module("app").factory("StorageSrv",["$window","$state","_LocalStorageSrv","LogSrv","Utils","localStorageDefault","appVersion",function(a,b,c,d,e,f,g){"use strict";function h(){for(var a in f){var b=a,d=f[b]||{},h=c.get(b)||{},j=e.extendDeep({},d,h);c.set(b,j)}var k=JSON.parse(localStorage.getItem("ngStorage-app"));k||(k=c.getApp()),""===k.version?(k.version=g,c.setApp(k)):k.version!==g&&(i(k.version,g),k=c.getApp(),k.version=g,c.setApp(k))}function i(e,g){if(d.trackUpgrade(e,g),localStorage){if("0.1.0"===e){c.reset();for(var h in f)c.set(h,f[h]);a.alert("For this upgrade, all data is reseted ! Sorry for the incovenience :("),b.go("intro")}if("0.2.0"===e||"0.3.0"===e){var i,j,k,l,m,n,o,p=JSON.parse(localStorage.getItem("ngStorage-app")),q=JSON.parse(localStorage.getItem("ngStorage-user")),r=JSON.parse(localStorage.getItem("ngStorage-data")),s=JSON.parse(localStorage.getItem("ngStorage-logs"));p&&(i=angular.copy(p)),q&&(j=angular.copy(q)),j&&!j.data&&(j.data={skipCookFeatures:!1,skipCartFeatures:!1}),j&&delete j.score,j&&delete j.profiles,j&&delete j.carts,j&&delete j.standaloneCookedRecipes,q&&q.profiles&&(k=angular.copy(q.profiles)),q&&q.carts&&(l={carts:angular.copy(q.carts)}),q&&q.standaloneCookedRecipes&&(m={recipes:angular.copy(q.standaloneCookedRecipes)}),s&&s.recipesHistory&&(n={recipes:angular.copy(s.recipesHistory)}),r&&r.globalmessage&&(o=angular.copy(r.globalmessages)),c.reset();for(var t in f)c.set(t,f[t]);i&&c.setApp(i),j&&c.setUser(j),k&&c.setUserProfiles(k),l&&c.setCarts(l),m&&c.setStandaloneCookedRecipes(m),n&&c.setRecipeHistory(n),o&&c.setGlobalmessages(o)}}}var j={init:h,getApp:c.getApp,getUser:c.getUser,saveUser:c.setUser,saveUserSetting:function(a,b){var d=c.getUser();d.settings[a]=b,c.setUser(d)},saveUserData:function(a,b){var d=c.getUser();d.data[a]=b,c.setUser(d)},getUserProfiles:c.getUserProfiles,getUserProfile:function(a){return c.getUserProfiles()[a]},saveUserProfiles:c.setUserProfiles,getFood:function(a){return c.getFoods().foods[a]},addFood:function(a){if(a&&a.id){var b=c.getFoods();b.foods[a.id]=a,c.setFoods(b)}},getRecipe:function(a){return c.getRecipes().recipes[a]},addRecipe:function(a){if(a&&a.id){var b=c.getRecipes();b.recipes[a.id]=a,c.setRecipes(b)}},getSelection:function(a){return c.getSelections().selections[a]},addSelection:function(a){if(a&&a.id){var b=c.getSelections();b.selections[a.id]=a,c.setSelections(b)}},getRecipeHistory:function(){return c.getRecipeHistory().recipes},addRecipeToHistory:function(a){if(a&&a.id){var b=c.getRecipeHistory();_.remove(b.recipes,{id:a.id}),b.recipes.unshift(a),c.setRecipeHistory(b)}},getCarts:function(){return c.getCarts().carts},saveCart:function(a){c.updateCarts("carts",a)},addCart:function(a){var b=c.getCarts();b.carts.unshift(a),c.setCarts(b)},getStandaloneCookedRecipes:function(){return c.getStandaloneCookedRecipes().recipes},addStandaloneCookedRecipe:function(a){var b=c.getStandaloneCookedRecipes();b.recipes.push(a),c.setStandaloneCookedRecipes(b)},getGlobalMessages:function(){return c.getGlobalmessages()},clearCache:function(){c.setFoods(f.dataFoods),c.setRecipes(f.dataRecipes),c.setSelections(f.dataSelections)},clear:function(){c.reset()}};return j}]).factory("_LocalStorageSrv",["$window",function(a){"use strict";function b(b){return!g[b]&&a.localStorage&&(g[b]=JSON.parse(a.localStorage.getItem("ionic-"+b))),angular.copy(g[b])}function c(b,c){angular.equals(g[b],c)?console.debug("Don't save <"+b+"> because values are equals !"):(g[b]=angular.copy(c),a.localStorage&&a.localStorage.setItem("ionic-"+b,JSON.stringify(c)))}function d(a,d,f){if(f&&f.id){var g=b(a);e(g[d],f),c(a,g)}}function e(a,b){if(Array.isArray(a)){var c=_.findIndex(a,{id:b.id});c>-1&&a.splice(c,1,b)}}function f(){if(a.localStorage){g={};for(var b in a.localStorage)a.localStorage.removeItem(b)}}var g={},h={getApp:function(){return b("app")},setApp:function(a){return c("app",a)},getUser:function(){return b("user")},setUser:function(a){return c("user",a)},getUserProfiles:function(){return b("userSocialProfiles")},setUserProfiles:function(a){return c("userSocialProfiles",a)},getFoods:function(){return b("dataFoods")},setFoods:function(a){return c("dataFoods",a)},getRecipes:function(){return b("dataRecipes")},setRecipes:function(a){return c("dataRecipes",a)},getSelections:function(){return b("dataSelections")},setSelections:function(a){return c("dataSelections",a)},getRecipeHistory:function(){return b("userRecipeHistory")},setRecipeHistory:function(a){return c("userRecipeHistory",a)},getCarts:function(){return b("userCarts")},setCarts:function(a){return c("userCarts",a)},updateCarts:function(a,b){return d("userCarts",a,b)},getStandaloneCookedRecipes:function(){return b("userStandaloneCookedRecipes")},setStandaloneCookedRecipes:function(a){return c("userStandaloneCookedRecipes",a)},getGlobalmessages:function(){return b("dataGlobalmessages")},setGlobalmessages:function(a){return c("dataGlobalmessages",a)},get:b,set:c,reset:f};return h}]),angular.module("app").factory("BackendSrv",["$q","$http","StorageSrv","firebaseUrl",function(a,b,c,d){"use strict";function e(e){var f=c.getRecipe(e);return f?a.when(f):b.get(d+"/recipes/"+e+".json").then(function(a){var b=a.data;if(b&&b.ingredients)for(var d in b.ingredients){var e=b.ingredients[d];if(e&&e.food&&e.food.category&&"string"==typeof e.food.category){var f=_.find(j,{name:e.food.category});e.food.category=f?angular.copy(f):{id:15,order:15,name:e.food.category,slug:getSlug(e.food.category)}}}return c.addRecipe(b),b})}function f(e){var f=c.getSelection(e);return f?a.when(f):b.get(d+"/selections/"+e+".json").then(function(a){return g(a.data)}).then(function(a){return c.addSelection(a),a})}function g(b){if(b&&b.recipes){var c=[];for(var d in b.recipes)c.push(e(b.recipes[d].id));return a.all(c).then(function(a){return b.recipes=a,b})}return a.when(b)}function h(){return b.get(d+"/globalmessages.json").then(function(a){return a.data})}var i={getRecipe:e,getSelection:f,getMessages:h},j=[{id:1,order:1,name:"Fruits & Légumes"},{id:2,order:2,name:"Viandes & Poissons"},{id:3,order:3,name:"Frais"},{id:4,order:4,name:"Pains & Pâtisseries"},{id:5,order:5,name:"Épicerie salée"},{id:6,order:6,name:"Épicerie sucrée"},{id:7,order:7,name:"Boissons"},{id:8,order:8,name:"Bio"},{id:9,order:9,name:"Bébé"},{id:10,order:10,name:"Hygiène & Beauté"},{id:11,order:11,name:"Entretien & Nettoyage"},{id:12,order:12,name:"Animalerie"},{id:13,order:13,name:"Bazar & Textile"},{id:14,order:14,name:"Surgelés"}];for(var k in j)j[k].slug=getSlug(j[k].name);return i}]).factory("LoginSrv",["$rootScope","$q","$timeout","StorageSrv","$firebaseSimpleLogin","UserSrv","firebaseUrl",function(a,b,c,d,e,f,g){"use strict";function h(a){return r="password",o=b.defer(),u.$createUser(a.email,a.password).then(function(){u.$login(r,{email:a.email,password:a.password,rememberMe:!0})},function(a){o.reject(a)}),o.promise}function i(a){var b={email:a.email,password:a.password};return m("password",b)}function j(){var a="facebook",b={scope:"email"},c=d.getUserProfile(a);return c&&c.accessToken&&(b.access_token=c.accessToken),m(a,b)}function k(){var a="twitter",b={},c=d.getUserProfile(a);return c&&c.accessToken&&(b.oauth_token=c.accessToken,b.oauth_token_secret=c.accessTokenSecret,b.user_id=c.id),m(a,b)}function l(){return m("google",{})}function m(a,c){return r=a,o=b.defer(),c.rememberMe=!0,u.$login(r,c),o.promise}function n(){return p=b.defer(),u.$logout(),q=c(function(){var a=d.getUser();a.isLogged=!1,d.saveUser(a),p.resolve()},1e3),p.promise}var o,p,q,r,s={isLogged:function(){return d.getUser().isLogged},register:h,login:i,facebookConnect:j,twitterConnect:k,googleConnect:l,logout:n},t=new Firebase(g),u=e(t);return a.$on("$firebaseSimpleLogin:login",function(a,b){if(o){var c=d.getUserProfiles();c[r]=b,d.saveUserProfiles(c),f.updateUserProfile().then(function(){var a=d.getUser();a.isLogged=!0,a.loggedWith=r,d.saveUser(a),o.resolve(a)})}}),a.$on("$firebaseSimpleLogin:logout",function(){if(p){c.cancel(q);var a=d.getUser();a.isLogged=!1,d.saveUser(a),p.resolve()}}),a.$on("$firebaseSimpleLogin:error",function(a,b){var c={provider:r};b.code&&(c.code=b.code),c.message=b.message?b.message.replace("FirebaseSimpleLogin: ",""):"Unexpected error occur :(",o&&o.reject(c),p&&p.reject(c)}),s}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("intro",{url:"/intro",templateUrl:"scripts/launch/intro.html",controller:"IntroCtrl"})}]).controller("IntroCtrl",["$scope","$state","StorageSrv","LoginSrv","LogSrv",function(a,b,c,d,e){"use strict";var f=0;a.startApp=function(){e.trackIntroExit(f);var a=c.getUser();a.skipIntro=!0,c.saveUser(a),b.go(d.isLogged()?"app.home":"login")},a.slideChanged=function(a){e.trackIntroChangeSlide(f,a),f=a}}]).factory("LaunchSrv",["$rootScope","$window","$state","$ionicPlatform","$ionicLoading","StorageSrv","LogSrv","Utils","debug",function(a,b,c,d,e,f,g,h,i){"use strict";function j(){d.ready(function(){var a=f.getUser();a.device=h.getDevice(),f.saveUser(a),g.identify(a.device.uuid),g.registerUser(),g.trackInstall(a.device.uuid),k()})}function k(){var d=f.getUser();g.identify(d.device.uuid);var h=Date.now()-INIT;i&&ionic.Platform.isWebView()&&b.plugins.toast.show("Application started in "+h+" ms"),g.trackLaunch(d.device.uuid,h);var j=Date.now();a.$on("$stateChangeSuccess",function(a,b,d,e,f){var h={};if(e&&e.name&&(h.fromUrl=c.href(e.name,f)),e&&e.name&&(h.from=e.name),f&&!l(f)&&(h.fromParams=f),b&&b.name&&(h.toUrl=c.href(b.name,d)),b&&b.name&&(h.to=b.name),d&&!l(d)&&(h.toParams=d),j){var i=Date.now();h.timePassed=i-j,j=i}g.trackState(h)}),a.$on("$stateChangeError",function(a,b,c,d,e,f){var h={};d&&d.name&&(h.from=d.name),e&&!l(e)&&(h.fromParams=e),b&&b.name&&(h.to=b.name),c&&!l(c)&&(h.toParams=c),f&&!l(f)&&(h.error=f),g.trackStateError(h)}),a.$on("$stateNotFound",function(a,b,c,d){var e={};c&&c.name&&(e.from=c.name),d&&!l(d)&&(e.fromParams=d),b&&b.to&&(e.to=b.to),b&&b.toParams&&!l(b.toParams)&&(e.toParams=b.toParams),g.trackStateNotFound(e)}),a.$on("$stateChangeStart",function(a,b,d,e){f.getUser().isLogged?b.data&&b.data.restrict&&"notConnected"===b.data.restrict&&(a.preventDefault(),console.log("Not allowed to go to "+b.name+" (you are connected !)"),e.data&&e.data.restrict&&"notConnected"===e.data.restrict&&c.go("app.home")):b.data&&b.data.restrict&&"connected"===b.data.restrict&&(a.preventDefault(),console.log("Not allowed to go to "+b.name+" (you are not connected !)"),e.data&&e.data.restrict&&"connected"===e.data.restrict&&c.go("login"))}),a.$on("$stateChangeSuccess",function(a,c){b.plugins&&b.plugins.insomnia&&(c&&c.data&&c.data.noSleep?b.plugins.insomnia.keepAwake():b.plugins.insomnia.allowSleepAgain())}),a.$on("$stateChangeStart",function(){e.show()}),a.$on("$stateChangeSuccess",function(){e.hide()})}function l(a){return 0===Object.keys(a).length}var m={launch:function(){var a=f.getUser();a&&a.device&&a.device.uuid?k():j()}};return m}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("login",{url:"/login",templateUrl:"scripts/auth/login.html",controller:"LoginCtrl",data:{restrict:"notConnected"}}).state("login-email",{url:"/login-email",templateUrl:"scripts/auth/login-email.html",controller:"LoginCtrl",data:{restrict:"notConnected"}})}]).controller("LoginCtrl",["$scope","$state","$window","PopupSrv","UserSrv","LoginSrv","SelectionSrv","LogSrv",function(a,b,c,d,e,f,g,h){"use strict";function i(b,g){a.loading[b]=!0;var i;"facebook"===b&&(i=f.facebookConnect()),"twitter"===b&&(i=f.twitterConnect()),"google"===b?i=f.googleConnect():"email"===b&&g&&"login"===g?i=f.login(a.credentials):"email"===b&&g&&"login"!==g&&(i=f.register(a.credentials)),i?i.then(function(a){e.hasMail()?j(b,a):d.askMail().then(function(c){e.setEmail(c).then(function(){j(b,a)})})},function(d){h.trackError("login:"+b,d),a.loading[b]=!1,c.plugins.toast.show(d.message),a.state.hasError=!0,a.credentials.password=""}):a.loading[b]=!1}function j(c,d){a.loading[c]=!1,h.trackLogin(c,d),h.registerUser(),b.go("app.home")}g.getCurrent(),a.credentials={email:"",password:""},a.loading={facebook:!1,twitter:!1,google:!1,email:!1},a.state={hasError:!1},a.goIntro=function(){e.get().skipIntro=!1,b.go("intro")},a.facebookConnect=function(){i("facebook")},a.twitterConnect=function(){i("twitter")},a.googleConnect=function(){i("google")},a.emailConnect=function(a){i("email",a)}}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.cart",{url:"/cart","abstract":!0,views:{menuContent:{templateUrl:"scripts/cart/cart.html",controller:"CartCtrl"}},data:{restrict:"connected"}}).state("app.cart.recipes",{url:"/recipes",templateUrl:"scripts/cart/cart-recipes.html",controller:"CartRecipesCtrl",data:{restrict:"connected"}}).state("app.cart.ingredients",{url:"/ingredients",templateUrl:"scripts/cart/cart-ingredients.html",controller:"CartIngredientsCtrl",data:{noSleep:!0,restrict:"connected"}})}]).controller("CartCtrl",["$scope","$state","$ionicPopover","$window","CartSrv","LogSrv",function(a,b,c,d,e,f){"use strict";
a.cart=e.hasOpenedCarts()?e.getOpenedCarts()[0]:e.createCart(),c.fromTemplateUrl("scripts/cart/cart-popover.html",{scope:a}).then(function(b){a.popover=b}),a.isCartEmpty=function(){return!(a.cart&&(a.cart.recipes&&a.cart.recipes.length>0||a.cart.customItems&&a.cart.customItems.length>0))},a.archiveCart=function(){d.confirm("Archiver cette liste ?")&&(f.trackArchiveCart(),e.archive(a.cart),a.popover.remove(),b.go("app.home"))}}]).controller("CartRecipesCtrl",["$scope","$window","CartSrv","StorageSrv","LogSrv",function(a,b,c,d,e){"use strict";a.selectedRecipe=null,a.toggleRecipe=function(b){a.selectedRecipe===b?(e.trackCartRecipeDetails(b.id,"hide"),a.selectedRecipe=null):(e.trackCartRecipeDetails(b.id,"show"),a.selectedRecipe=b)},a.removeRecipeFromCart=function(d){e.trackRemoveRecipeFromCart(d.id,null,"cart"),c.removeRecipe(a.cart,d),b.plugins.toast.show("✔ recette supprimée de la liste de courses")},a.updateServings=function(){d.saveCart(a.cart)}}]).controller("CartIngredientsCtrl",["$scope","CartSrv","StorageSrv","PopupSrv","LogSrv","Utils",function(a,b,c,d,e,f){"use strict";function g(a){return"string"==typeof a?_.filter(_.map(a.split("\n"),function(a){var b=a.trim();return b.length>0?f.endsWith(b," ok")?{bought:!0,name:b.replace(/ ok/g,"")}:{bought:!1,name:b}:void 0}),function(a){return a&&a.name&&a.name.length>0}):Array.isArray(a)?angular.copy(a.trim()):void e.trackError("cartCustomItemsError",{message:"Can't parse customItems",customItems:angular.copy(a)})}function h(a){return"string"==typeof a?angular.copy(a.trim()):Array.isArray(a)?_.map(a,function(a){return a.name+(a.bought?" ok":"")}).join("\n"):void e.trackError("cartCustomItemsError",{message:"Can't parse customItems",customItems:angular.copy(a)})}var i=c.getUser();i&&i.data&&i.data.skipCartFeatures||d.tourCartFeatures().then(function(){i.data.skipCartFeatures=!0,c.saveUser(i)}),Array.isArray(a.cart.customItems)||(a.cart.customItems=g(a.cart.customItems),c.saveCart(a.cart)),a.customItems=a.cart.customItems,a.items=b.getItems(a.cart),a.editingCustomItems=!1,a.customItemsText="",a.editCustomItems=function(){a.editingCustomItems||(a.editingCustomItems=!0,a.customItemsText=h(a.cart.customItems))},a.cancelCustomItems=function(){a.customItemsText="",a.editingCustomItems=!1},a.saveCustomItems=function(){a.cart.customItems=g(a.customItemsText),a.customItems=a.cart.customItems,c.saveCart(a.cart),a.customItemsText="",a.editingCustomItems=!1,e.trackEditCartCustomItems(a.cart.customItems)},a.buyCustomItem=function(b){b.bought=!0,c.saveCart(a.cart)},a.unbuyCustomItem=function(b){b.bought=!1,c.saveCart(a.cart)},a.openedItems=[],a.isOpened=function(b){return _.findIndex(a.openedItems,{food:{id:b.food.id}})>-1},a.toggleItem=function(b){var c=_.findIndex(a.openedItems,{food:{id:b.food.id}});e.trackCartItemDetails(b.food.id,c>-1?"hide":"show"),c>-1?a.openedItems.splice(c,1):a.openedItems.push(b)},a.cartHasItems=function(){return a.items.length>0||a.customItems.length>0},a.cartHasItemsToBuy=function(){var b=_.filter(a.items,function(b){return!a.isBought(b)});return b.length>0},a.cartHasCustomItemsToBuy=function(){var b=_.filter(a.customItems,function(a){return!a.bought});return b.length>0},a.isBought=function(a){var b=!0;return angular.forEach(a.sources,function(a){a.ingredient.bought||(b=!1)}),b},a.buyItem=function(c){e.trackBuyItem(c.food.id),b.buyItem(a.cart,c)},a.unbuyItem=function(c){e.trackUnbuyItem(c.food.id),b.unbuyItem(a.cart,c)}}]).factory("CartSrv",["StorageSrv","_CartBuilder","_CartUtils",function(a,b,c){"use strict";function d(){return _.findIndex(a.getCarts(),{archived:!1})>-1}function e(){return _.filter(a.getCarts(),{archived:!1})}function f(b){return _.find(a.getCarts(),{id:b})}function g(a,b){var c=f(a);return c?_.find(c.recipes,{id:b}):null}function h(c){var d=b.createCart(c);return a.addCart(d),d}function i(){return s(e())}function j(){var a=i();return c.recipesToItems(a)}function k(){var b=s(a.getCarts());return _.filter(b,{cartData:{cooked:!1}})}function l(){var b=s(a.getCarts()),c=_.reject(b,{cartData:{cooked:!1}});return c.concat(a.getStandaloneCookedRecipes())}function m(a){return c.recipesToItems(a.recipes)}function n(a,b){return _.findIndex(a.recipes,{id:b.id})>-1}function o(c,d,e){var f=b.createRecipe(c,d,e);c.recipes.push(f),a.saveCart(c)}function p(b,c){_.remove(b.recipes,{id:c.id}),a.saveCart(b)}function q(b,d,e){_.map(d.sources,function(a){a.ingredient.bought=e});for(var f in d.sources){var g=d.sources[f].recipe;g.cartData.boughtPc=c.boughtPercentage(g)}a.saveCart(b)}function r(b){b.archived=!0,a.saveCart(b)}function s(a){return _.reduce(a,function(a,b){return a.concat(b.recipes)},[])}var t={getCarts:a.getCarts,hasOpenedCarts:d,getOpenedCarts:e,getCart:f,getCartRecipe:g,createCart:h,recipesFromOpenedCarts:i,itemsFromOpenedCarts:j,getRecipesToCook:k,getCookedRecipes:l,addStandaloneCookedRecipe:a.addStandaloneCookedRecipe,getItems:m,hasRecipe:n,addRecipe:o,removeRecipe:p,buyItem:function(a,b){q(a,b,!0)},unbuyItem:function(a,b){q(a,b,!1)},archive:r};return t}]).factory("_CartUtils",["$window","_CartBuilder",function(a,b){"use strict";function c(a){var c=[];return _.map(a,function(a){_.map(a.ingredients,function(d){var e=_.find(c,{food:{id:d.food.id}});e?b.addSourceToItem(e,d,a):c.push(b.createItem(d,a))})}),e(c),c}function d(a){if(a&&a.cartData&&a.ingredients&&a.ingredients.length>0){var b=0;for(var c in a.ingredients)a.ingredients[c].bought&&b++;return 100*b/a.ingredients.length}return 100}function e(a){a.sort(function(a,b){var c=a&&a.food&&a.food.category&&a.food.category.order?a.food.category.order:50,d=b&&b.food&&b.food.category&&b.food.category.order?b.food.category.order:50,e=a&&a.name?a.name.toLowerCase():"",f=b&&b.name?b.name.toLowerCase():"";return c>d?1:d>c?-1:e>f?1:f>e?-1:0})}var f={recipesToItems:c,boughtPercentage:d};return f}]).factory("_CartBuilder",["IngredientUtils","Utils",function(a,b){"use strict";function c(a){return{id:b.createUuid(),created:Date.now(),archived:!1,name:a?a:"Liste du "+moment().format("LL"),recipes:[],customItems:[]}}function d(a,b,c){var d=angular.copy(b);return d.cartData={cart:a.id,created:Date.now(),boughtPc:0,cooked:!1,servings:{value:c,unit:b.servings.unit}},d}function e(a,b){var c=angular.copy(a),d=g(a,b);return c.price=d.price,c.quantity=d.quantity,c.sources=[d],c}function f(b,c,d){var e=g(c,d),f=a.sum([b,e]);b.price=f.price,b.quantity=f.quantity,b.sources.push(e)}function g(b,c){return{price:a.adjustForServings(b.price,c.servings,c.cartData.servings),quantity:a.adjustForServings(b.quantity,c.servings,c.cartData.servings),ingredient:b,recipe:c}}var h={createCart:c,createRecipe:d,createItem:e,addSourceToItem:f};return h}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.recipes",{url:"/recipes",views:{menuContent:{templateUrl:"scripts/recipe/recipes.html",controller:"RecipesCtrl"}},data:{restrict:"connected"}}).state("app.recipe",{url:"/recipe/:recipeId",views:{menuContent:{templateUrl:"scripts/recipe/recipe.html",controller:"RecipeCtrl"}},data:{restrict:"connected"}}).state("app.cook",{url:"/cook/:cartId/:recipeId",views:{menuContent:{templateUrl:"scripts/recipe/cook.html",controller:"CookCtrl"}},data:{noSleep:!0,restrict:"connected"}}).state("app.tocook",{url:"/tocook",views:{menuContent:{templateUrl:"scripts/recipe/tocook.html",controller:"TocookCtrl"}},data:{restrict:"connected"}}).state("app.cooked",{url:"/cooked",views:{menuContent:{templateUrl:"scripts/recipe/cooked.html",controller:"CookedCtrl"}},data:{restrict:"connected"}})}]).controller("RecipesCtrl",["$rootScope","$scope","$state","$window","PopupSrv","SelectionSrv","StorageSrv","CartSrv","LogSrv",function(a,b,c,d,e,f,g,h,i){"use strict";b.loading=!0,b.recipesOfWeek={},f.getCurrent().then(function(a){b.recipesOfWeek=a,b.loading=!1});var j=h.hasOpenedCarts()?h.getOpenedCarts()[0]:h.createCart();b.cartHasRecipe=function(a){return h.hasRecipe(j,a)},b.toggleIngredients=function(a){a.showIngredients=!a.showIngredients},b.addRecipeToCart=function(b,c){e.changeServings(a.ctx.settings.defaultServings,b.name).then(function(e){e&&(i.trackAddRecipeToCart(b.id,e,c,"selection"),a.ctx.settings.defaultServings=e,g.saveUserSetting("defaultServings",e),h.addRecipe(j,b,e),d.plugins.toast.show("✔ recette ajoutée à la liste de courses"),g.addRecipeToHistory(b))})},b.removeRecipeFromCart=function(a,b){i.trackRemoveRecipeFromCart(a.id,b,"selection"),h.removeRecipe(j,a),d.plugins.toast.show("✔ recette supprimée de la liste de courses")},b.recipeFeedback=function(a){i.trackRecipesFeedback(b.recipesOfWeek.week,a),c.go("app.feedback",{source:"recipes-rating-"+a})}}]).controller("RecipeCtrl",["$rootScope","$scope","$stateParams","$window","CartSrv","StorageSrv","BackendSrv","PopupSrv","LogSrv",function(a,b,c,d,e,f,g,h,i){"use strict";b.recipe={},g.getRecipe(c.recipeId).then(function(a){f.addRecipeToHistory(a),b.recipe=a});var j=e.hasOpenedCarts()?e.getOpenedCarts()[0]:e.createCart();b.cartHasRecipe=function(a){return e.hasRecipe(j,a)},b.addRecipeToCart=function(b){h.changeServings(a.settings.defaultServings,b.name).then(function(c){c&&(i.trackAddRecipeToCart(b.id,c,null,"recipe"),a.settings.defaultServings=c,f.saveUserSetting("defaultServings",c),e.addRecipe(j,b,c),d.plugins.toast.show("✔ recette ajoutée à la liste de courses"))})},b.removeRecipeFromCart=function(a){i.trackRemoveRecipeFromCart(a.id,null,"recipe"),e.removeRecipe(j,a),d.plugins.toast.show("✔ recette supprimée de la liste de courses")}}]).controller("CookCtrl",["$scope","$state","$stateParams","$window","CartSrv","StorageSrv","BackendSrv","PopupSrv","LogSrv","Utils",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(b){if(b){a.recipe=b,f.addRecipeToHistory(a.recipe),a.servings=a.recipe.cartData?a.recipe.cartData.servings.value:a.recipe.servings.value,a.servingsAdjust=a.servings/a.recipe.servings.value,a.timer=moment.duration(a.recipe.time.eat,"minutes").asSeconds();var c=f.getUser();c&&c.data&&c.data.skipCookFeatures?m():h.tourCookFeatures().then(function(){c.data.skipCookFeatures=!0,f.saveUser(c),m()})}else i.trackError("notFoundCookRecipe",{message:"Unable to find cook recipe !",cartId:p,recipeId:q}),d.alert("Error: forbidden action !\nCan't cook recipe from "+p+"/"+q+" !\nPlease contact loicknuchel@gmail.com !")}function l(a,b,c){if(a&&a.cartData)a.cartData.cooked={time:Date.now(),duration:c};else{var d=angular.copy(a);d.cartData={cooked:{time:Date.now(),duration:c},servings:{value:b,unit:d.servings.unit}},e.addStandaloneCookedRecipe(d)}}function m(){o=Date.now(),r=j.clock(function(){a.timer--}),a.$on("$destroy",function(){n()})}function n(){j.cancelClock(r),r=null}var o,p=c.cartId,q=c.recipeId,r=null;a.timer=0,"none"===p?g.getRecipe(q).then(function(a){k(a)}):k(e.getCartRecipe(p,q)),a.changeServings=function(){h.changeServings(a.servings).then(function(b){b&&(a.servings=b,a.servingsAdjust=a.servings/a.recipe.servings.value)})},a.done=function(){var c=300,e=(Date.now()-o)/1e3;c>e?(d.history.back(),d.plugins.toast.show("T'as pas cuisiné, avoue ! ;)")):(i.trackRecipeCooked(a.recipe.id,e),l(a.recipe,a.servings,e),h.recipeCooked().then(function(a){a?navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp():b.go("app.home")}))}}]).controller("TocookCtrl",["$scope","PopupSrv","CartSrv",function(a,b,c){"use strict";a.recipes=c.getRecipesToCook(),a.recipes.sort(function(a,b){var c=-(a.cartData.boughtPc-b.cartData.boughtPc);return 0===c?-(a.cartData.created-b.cartData.created):c}),a.changeServings=function(c){b.changeServings(a.servings).then(function(a){a&&(c.cartData.servings.value=a)})}}]).controller("CookedCtrl",["$scope","CartSrv",function(a,b){"use strict";a.recipes=b.getCookedRecipes(),a.recipes.sort(function(a,b){return-(a.cartData.cooked.time-b.cartData.cooked.time)})}]).factory("SelectionSrv",["StorageSrv","BackendSrv","debug",function(a,b,c){"use strict";var d={getCurrent:function(){return b.getSelection(moment().week()+(c?1:0))}};return d}]).directive("cookTimer",["$timeout","$ionicScrollDelegate","MediaSrv","Utils",function(a,b,c,d){"use strict";function e(a){return a.pData?angular.copy(a.pData):a.pSteps?{color:a.pColor,label:a.pLabel,steps:angular.copy(a.pSteps)}:{color:a.pColor,label:a.pLabel,seconds:a.pSeconds}}var f=60;return{restrict:"E",templateUrl:"scripts/recipe/timer.html",scope:{pData:"=data",pColor:"=color",pLabel:"=label",pSeconds:"=seconds",pSteps:"=steps"},link:function(g){function h(){s.scroll=r.getScrollPosition(),s.clock=d.clock(function(){if(s.duration-g.time>0){if(g.time++,s.duration===g.time+f/2)p();else if(s.duration===g.time)q();else if(s.steps)for(var a in s.steps)s.steps[a].time===g.time+f/2&&n(s.steps[a]),s.steps[a].time===g.time&&o(s.steps[a])}else i()})}function i(){d.cancelClock(s.clock),s.clock=null}function j(){s.alarm===!1&&(s.alarm=!0,s.media.play(),r.scrollTo(s.scroll.left,s.scroll.top,!0))}function k(){s.alarm===!0&&s.media.play()}function l(){s.alarm===!0&&(s.alarm=!1,s.media.stop(),s.media.release())}function m(){s&&s.media&&(s.media.play(),a(function(){s.media.stop()},1200),s.scroll&&r.scrollTo(s.scroll.left,s.scroll.top,!0))}function n(){}function o(){m()}function p(){}function q(){j()}var r=b.$getByHandle("cookScroll"),s=e(g);if(s.duration=null,s.clock=null,s.alarm=!1,s.media=null,s.scroll=null,g.timer=s,c.loadTimerAlarm(k).then(function(a){s.media=a}),g.time=0,s.steps&&s.steps.length>0){var t=s.steps[s.steps.length-1];s.duration=t.time?t.time:0}else s.duration=s.seconds?s.seconds:0;g.isSelected=function(a){return a.time-f/2<=g.time&&g.time<a.time+f/2},g.isUnselected=function(a){return g.time>=a.time+f/2},g.timerClick=function(){s.alarm===!0?l():null!==s.clock?i():h()},g.$on("$destroy",function(){l()})}}}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.profile",{url:"/profile",views:{menuContent:{templateUrl:"scripts/user/profile.html",controller:"ProfileCtrl"}},data:{restrict:"connected"}}).state("app.feedback",{url:"/feedback?source",views:{menuContent:{templateUrl:"scripts/user/feedback.html",controller:"FeedbackCtrl"}},data:{restrict:"connected"}})}]).controller("ProfileCtrl",["$scope","$state","$window","StorageSrv","UserSrv","LoginSrv","LogSrv",function(a,b,c,d,e,f,g){"use strict";function h(a,b){var c=i(a);return c&&void 0!==_.find(b,function(a){return a===c})?!0:!1}function i(a){return a&&a.profiles&&a.profiles.gravatar&&a.profiles.gravatar.entry&&a.profiles.gravatar.entry.length>0&&a.profiles.gravatar.entry[0].profileBackground&&a.profiles.gravatar.entry[0].profileBackground.url?a.profiles.gravatar.entry[0].profileBackground.url:void 0}var j=d.getUser(),k=["images/profile-covers/cover01.jpg","images/profile-covers/cover02.jpg","images/profile-covers/cover03.jpg","images/profile-covers/cover04.jpg","images/profile-covers/cover05.jpg","images/profile-covers/cover06.jpg","images/profile-covers/cover07.jpg","images/profile-covers/cover08.jpg","images/profile-covers/cover09.jpg","images/profile-covers/cover10.jpg","images/profile-covers/cover11.jpg","images/profile-covers/cover12.jpg","images/profile-covers/cover13.jpg","images/profile-covers/cover14.jpg","images/profile-covers/cover15.jpg","images/profile-covers/cover16.jpg","images/profile-covers/cover17.jpg","images/profile-covers/cover18.jpg","images/profile-covers/cover19.jpg","images/profile-covers/cover20.jpg","images/profile-covers/cover21.jpg","images/profile-covers/cover22.jpg","images/profile-covers/cover23.jpg","images/profile-covers/cover24.jpg"];!h(j,k)&&i(j)&&k.unshift(i(j));var l=-1;a.changeCover=function(){l=(l+1)%k.length,j.backgroundCover=k[l],d.saveUser(j),g.trackChangeSetting("profileCover",j.backgroundCover),g.registerUser()},a.clearCache=function(){c.confirm("Vider le cache ?")&&(g.trackClearCache(j.device.uuid),d.clearCache())},a.logout=function(){f.logout().then(function(){g.trackLogout(j.device.uuid),b.go("login")},function(a){g.trackError("logout",a),c.plugins.toast.show(a.message)})},a.resetApp=function(){c.confirm("Réinitialiser complètement l'application ?")&&(g.trackClearApp(j.device.uuid),d.clear(),navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},a.$watch("ctx.settings.showPrices",function(a,b){a!==b&&(d.saveUserSetting("showPrices",a),g.trackChangeSetting("showPrices",a),g.registerUser())}),a.$watch("ctx.settings.bigImages",function(a,b){a!==b&&(d.saveUserSetting("bigImages",a),g.trackChangeSetting("bigImages",a),g.registerUser())})}]).controller("FeedbackCtrl",["$scope","$stateParams","$window","UserSrv","StorageSrv","EmailSrv","LogSrv",function(a,b,c,d,e,f,g){"use strict";var h=e.getApp(),i=e.getUser();a.feedback={email:i.email,content:"",sending:!1,sent:!1},b.source&&("recipes-rating-1"===b.source?a.feedback.content="Bof bof bof... Tiens quelques conseils !\n\nJe serais plus fan de ...":"recipes-rating-2"===b.source?a.feedback.content="Plutôt cool tes recettes !\n\nJe verrais bien un peu plus ... ou un peu moins de ...":"recipes-rating-3"===b.source&&(a.feedback.content="Wahou c'est top !\n\nEt ça serait encore mieux si tu pouvais ...")),a.sendFeedback=function(){a.feedback.sending=!0,g.trackSendFeedback(a.feedback.email),f.sendFeedback(a.feedback.email,a.feedback.content).then(function(b){a.feedback.sending=!1,b?a.feedback.sent=!0:c.alert("Echec de l'envoi du email. Réessayez !")}),i.email!==a.feedback.email&&(g.trackSetEmail(a.feedback.email),d.setEmail(a.feedback.email).then(function(){g.registerUser()}))},a.openUservoice=function(){g.trackOpenUservoice()},UserVoice.push(["set",{accent_color:"#f62",trigger_color:"white",trigger_background_color:"#f62"}]);var j={};i&&i.email&&(j.email=i.email),i&&i.name&&(j.name=i.name),h&&h.firstLaunch&&(j.created_at=h.firstLaunch/1e3),i&&i.device&&i.device.uuid&&(j.id=i.device.uuid),UserVoice.push(["identify",j]),UserVoice.push(["addTrigger","#uservoice",{mode:"smartvote"}]),UserVoice.push(["autoprompt",{}])}]).factory("UserSrv",["$q","StorageSrv","$http","localStorageDefault","md5",function(a,b,c,d,e){"use strict";function f(){var a=b.getUser();return a&&a.email&&a.email.length>0}function g(c){var d=b.getUser();return d.email=c,b.saveUser(d),c?i(c).then(function(){return h()}):a.when()}function h(){var c=b.getUser(),d=b.getUserProfiles(),e=j(),f=k(d.gravatar),g=l(d.password),h=m(d.twitter),p=n(d.facebook),q=o(d.google);return angular.extend(c,e,f,g,h,p,q),angular.extend(c.more,e.more,f.more,g.more,h.more,p.more,q.more),c.email!==f.email?i(c.email).then(function(a){f=k(a),angular.extend(c,e,f,g,h,p,q),angular.extend(c.more,e.more,f.more,g.more,h.more,p.more,q.more),b.saveUser(c)}):(b.saveUser(c),a.when(c))}function i(c){if(c&&c.length>0){var d=e.createHash(c),f=(b.getUser(),{entry:[{email:c,hash:d}]});return a.when(f).then(function(a){var c=b.getUserProfiles();return c.gravatar=a,b.saveUserProfiles(c),a})}return a.when()}function j(){return{email:d.user.email,name:d.user.name,avatar:d.user.avatar,background:d.user.background,backgroundCover:d.user.backgroundCover,firstName:d.user.firstName,lastName:d.user.lastName,more:{}}}function k(a){var b={more:{}};if(a&&a.entry&&a.entry.length>0){var c=a.entry[0];if(c.email&&(b.email=c.email),c.displayName&&(b.name=c.displayName),c.thumbnailUrl&&(b.avatar=c.thumbnailUrl),c.aboutMe&&(b.more.gravatarDescription=c.aboutMe),c.hash&&(b.more.gravatarHash=c.hash),c.profileUrl&&(b.more.gravatarProfile=c.profileUrl),c.currentLocation&&(b.more.gravatarLocation=c.currentLocation),c.name&&(c.name.givenName&&(b.firstName=c.name.givenName),c.name.familyName&&(b.lastName=c.name.familyName),c.name.formatted&&(b.name=c.name.formatted)),c.profileBackground&&(c.profileBackground.color&&(b.background=c.profileBackground.color),c.profileBackground.url&&(b.backgroundCover=c.profileBackground.url)),c.accounts&&c.accounts.length>0)for(var d in c.accounts){var e=c.accounts[d];e.shortname&&e.url&&(b.more[e.shortname+"Profile"]=e.url),e.shortname&&e.username&&(b.more[e.shortname+"Username"]=e.username)}}return b}function l(a){var b={more:{}};return a&&(a.email&&(b.email=a.email),a.id&&(b.more.firebaseId=a.id)),b}function m(a){var b={more:{}};if(a&&(a.displayName&&(b.name=a.displayName),a.username&&(b.more.twitterUsername=a.username),a.username&&(b.more.twitterProfile="https://twitter.com/"+a.username),a.id&&(b.more.twitterId=a.id),a.thirdPartyUserData)){var c=a.thirdPartyUserData;c.profile_image_url&&(b.avatar=c.profile_image_url.replace("_normal.","_bigger.")),c.profile_background_color&&(b.background="#"+c.profile_background_color),c.profile_background_image_url_https&&(b.backgroundCover=c.profile_background_image_url_https),c.description&&(b.more.twitterDescription=c.description),c.followers_count&&(b.more.twitterFollowers=c.followers_count)}return b}function n(a){var b={more:{}};if(a&&(a.displayName&&(b.name=a.displayName),a.id&&(b.more.facebookId=a.id),a.thirdPartyUserData)){var c=a.thirdPartyUserData;c.email&&(b.email=c.email),c.first_name&&(b.firstName=c.first_name),c.last_name&&(b.lastName=c.last_name),c.link&&(b.more.facebookProfile=c.link),c.gender&&(b.more.gender=c.gender),c.age_range&&(c.age_range.min&&(b.more.minAge=c.age_range.min),c.age_range.max&&(b.more.maxAge=c.age_range.max)),c.picture&&c.picture.data&&c.picture.data.url&&(b.avatar=c.picture.data.url.replace("p50x50","p100x100"))}return b}function o(a){var b={more:{}};if(a&&(a.displayName&&(b.name=a.displayName),a.email&&(b.email=a.email),a.id&&(b.more.googleId=a.id),a.thirdPartyUserData)){var c=a.thirdPartyUserData;c.given_name&&(b.firstName=c.given_name),c.family_name&&(b.lastName=c.family_name),c.picture&&(b.avatar=c.picture),c.gender&&(b.more.gender=c.gender),c.link&&(b.more.googleProfile=c.link)}return b}var p={hasMail:f,setEmail:g,updateUserProfile:h};return p}]);