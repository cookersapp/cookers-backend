angular.module("app",["ionic","ngSanitize","ngAnimate","ngTouch","pasvaz.bindonce","ngCordova","dcbImgFallback","monospaced.elastic"]).config(["$stateProvider","$urlRouterProvider","$provide",function(a,b,c){"use strict";c.decorator("$exceptionHandler",["$delegate",function(a){return function(b,c){a(b,c);var d={type:"angular"};c&&(d.cause=c),b&&(b.message&&(d.message=b.message),b.name&&(d.name=b.name),b.stack&&(d.stack=b.stack)),Logger.track("exception",{data:d})}}]),a.state("app",{url:"/app","abstract":!0,templateUrl:"views/sidemenu.html",controller:"AppCtrl"}).state("app.home",{url:"/home",views:{menuContent:{templateUrl:"views/home.html",controller:"HomeCtrl"}}}),b.otherwise("/app/home")}]).constant("Config",Config).constant("firebaseUrl","https://crackling-fire-7710.firebaseio.com").constant("supportTeamEmail","loic@cookers.io").constant("$ionicLoadingConfig",{template:'<loading color="rgba(255,255,255,0.7)"></loading>',noBackdrop:!0}).constant("imagesPlaceholders",{recipe:{portrait:"images/recipe_placeholder_384x524.jpg",landing:"images/recipe_placeholder_400x225.jpg",thumbnail:"images/recipe_placeholder_200x200.jpg"}}).value("localStorageDefault",{app:{version:""},userCarts:{carts:[]},userStandaloneCookedRecipes:{recipes:[]},userRecipeHistory:{recipes:[]},dataFoods:{foods:{}},dataRecipes:{recipes:{}},dataSelections:{selections:{}},dataGlobalmessages:{lastCall:null,messages:[]}}).run(["$rootScope","$location","LaunchSrv","StorageSrv","imagesPlaceholders","Config","PerfSrv",function(a,b,c,d,e,f){"use strict";var g=d.getUser();a.ctx={cfg:{imagesPlaceholders:e},settings:g?g.settings:null,debug:f.debug,appVersion:f.appVersion},c.launch().then(function(){g=d.getUser(),a.ctx.settings=g?g.settings:null}),a.isActive=function(a){var c=new RegExp("^"+a+"$","g");return c.test(b.path())},a.safeApply=function(a){var b=this.$root?this.$root.$$phase:this.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}]),angular.module("app").filter("date",function(){"use strict";return function(a,b){return a?moment(a).format(b?b:"ll"):"<date>"}}).filter("duration",["$filter",function(){"use strict";return function(a,b){if(a||0===a){if(b)return moment.duration(a,"seconds").humanize();var c=a>-60&&60>a?"00:":"";return c+moment.duration(a,"seconds").format("hh:mm:ss")}return console.warn("Unable to format duration",a),"<duration>"}}]).filter("mynumber",["$filter",function(a){"use strict";return function(b,c){var d=Math.pow(10,c?c:0);return a("number")(Math.round(b*d)/d)}}]).filter("unit",function(){"use strict";return function(a){return"piece"===a||"pièce"===a?"":a}}).filter("cookTime",["$filter",function(a){"use strict";return function(b){return b&&b.eat>0?a("mynumber")(b.eat,2)+" "+a("unit")(b.unit):""}}]).filter("servings",["$filter",function(a){"use strict";return function(b,c){return c||(c=1),b&&b.value>0?a("mynumber")(b.value*c,2)+" "+a("unit")(b.unit):""}}]).filter("price",["$filter",function(a){"use strict";return function(b,c,d){return b?(void 0===c&&(c=!0),void 0===d&&(d=1),a("mynumber")(b.value*d,2)+" "+b.currency+(c&&b.unit?"/"+b.unit:"")):"<price>"}}]).filter("quantity",["$filter",function(a){"use strict";return function(b,c){return c||(c=1),b&&b.value>0?a("mynumber")(b.value*c,2)+" "+a("unit")(b.unit):""}}]).filter("tool",function(){"use strict";return function(a){return a&&a.name?a.name:""}}).filter("ingredient",["$filter",function(a){"use strict";function b(a,b){return-1!==a.indexOf(b,a.length-b.length)}function c(a){return a&&a.pre?" "+a.pre+(b(a.pre,"'")?"":" "):" "}function d(a){return a&&a.post?" "+a.post:""}return function(b,e){return b?a("quantity")(b.quantity,e)+c(b)+b.food.name+d(b):""}}]),angular.module("app").factory("PerfSrv",function(){"use strict";function a(b){var c=[];return b.data().hasOwnProperty("$scope")&&angular.forEach(b.data().$scope.$$watchers,function(a){c.push(a)}),angular.forEach(b.children(),function(b){c=c.concat(a(angular.element(b)))}),c}var b={getWatchesForElement:a};return b}).factory("GlobalMessageSrv",["$q","StorageSrv","BackendSrv","Config",function($q,StorageSrv,BackendSrv,Config){"use strict";function getStandardMessageToDisplay(){var a="standard",b=findMessage(a);return b?(fetchMessages(),$q.when(b)):fetchMessages().then(function(){return findMessage(a)})}function getStickyMessages(){var a="sticky";return fetchMessages().then(function(){return findMessages(a)})}function execMessages(){var a="exec";return fetchMessages().then(function(){var b=findMessages(a);for(var c in b)b[c].exec&&execMessage(b[c].exec,b[c]),b[c].hide=!0;return b})}function findMessages(a){return _.filter(StorageSrv.getGlobalMessages().messages,function(b){return b.type===a&&!b.hide&&b.shouldDisplay&&execMessage(b.shouldDisplay,b)})}function findMessage(a){return _.find(StorageSrv.getGlobalMessages().messages,function(b){return b.type===a&&!b.hide&&b.shouldDisplay&&execMessage(b.shouldDisplay,b)})}function fetchMessages(){return StorageSrv.getGlobalMessages().lastCall=Date.now(),BackendSrv.getMessages().then(function(a){var b=_.filter(a,function(a){return a&&(a.isProd||Config.debug)&&a.targets&&a.targets.indexOf(Config.appVersion)>-1&&!messageExists(a)});StorageSrv.getGlobalMessages().messages=StorageSrv.getGlobalMessages().messages.concat(b),StorageSrv.getGlobalMessages().messages.sort(function(a,b){return a.created-b.created})})}function execMessage(fn,message){var user=StorageSrv.getUser();return eval(fn)}function messageExists(a){return a&&a.created&&_.findIndex(StorageSrv.getGlobalMessages().messages,{created:a.created})>-1}var service={getStandardMessageToDisplay:getStandardMessageToDisplay,getStickyMessages:getStickyMessages,execMessages:execMessages};return service}]).factory("EmailSrv",["$http","Config",function(a,b){"use strict";function c(c,d){return a.post(b.backendUrl+"/api/v1/app-feedback",{from:c,content:d,source:"mobile-app"}).then(function(a){return"sent"===a.data})}var d={sendFeedback:c};return d}]),angular.module("app").directive("blurOnKeyboardOut",["$window",function(a){"use strict";return{restrict:"A",link:function(b,c,d){a.addEventListener("native.keyboardhide",function(){c[0].blur(),b.safeApply(function(){b.$eval(d.blurOnKeyboardOut)})})}}}]).directive("focusOnKeyboardOpen",["$window",function(a){"use strict";return{restrict:"A",link:function(b,c){var d=!1;a.addEventListener("native.keyboardshow",function(){d=!0,c[0].focus()}),a.addEventListener("native.keyboardhide",function(){d=!1,c[0].blur()}),c[0].addEventListener("blur",function(){d&&c[0].focus()},!0)}}}]).directive("externalContent",["$compile",function(a){"use strict";return{restrict:"A",scope:{html:"=externalContent"},link:function(b,c){b.$watch("html",function(){c.html(""),c.append(a("<span>"+b.html+"</span>")(b))})}}}]).directive("href",["$window",function(a){"use strict";return{restrict:"A",scope:{url:"@href"},link:function(b,c){(0===b.url.indexOf("http://")||0===b.url.indexOf("https://"))&&c.bind("click",function(c){c.preventDefault(),a.open(encodeURI(b.url),"_system","location=yes")})}}}]).directive("loading",function(){"use strict";return{restrict:"E",scope:{color:"@"},template:'<div class="spinner"><div class="dot1" ng-style="style"></div><div class="dot2" ng-style="style"></div></div>',link:function(a){a.style=a.color?{"background-color":a.color}:{}}}}),angular.module("app").controller("AppCtrl",["$scope","$interval","StorageSrv","imagesPlaceholders",function(a,b,c,d){"use strict";a.defaultCovers=["images/sidemenu-covers/cover1.jpg","images/sidemenu-covers/cover2.jpg","images/sidemenu-covers/cover3.jpg","images/sidemenu-covers/cover4.png","images/sidemenu-covers/cover5.jpg","images/sidemenu-covers/cover6.jpg"],a.imageCover=a.defaultCovers[0],b(function(){var b=c.getRecipeHistory(),e=b?b.length:0;if(e>0&&Math.random()>e/a.defaultCovers.length){var f=b[Math.floor(Math.random()*e)].images;a.imageCover=f?f.landing:d.recipe.landing}else a.imageCover=a.defaultCovers[Math.floor(Math.random()*a.defaultCovers.length)]},1e4)}]).controller("HomeCtrl",["$scope","$timeout","GlobalMessageSrv","StorageSrv","EmailSrv","ToastSrv","SelectionSrv","Utils",function(a,b,c,d,e,f,g){"use strict";a.standardMessage=null,a.stickyMessages=[],g.getCurrent(),c.getStandardMessageToDisplay().then(function(b){a.standardMessage=b}),c.getStickyMessages().then(function(b){a.stickyMessages=b}),c.execMessages(),a.hideStandardMessage=function(){a.standardMessage.hide=!0,a.standardMessage=null,b(function(){c.getStandardMessageToDisplay().then(function(b){a.standardMessage=b})},3e3)}}]),angular.module("app").factory("ToastSrv",["$window","$ionicPlatform","LogSrv",function(a,b,c){"use strict";function d(b,c,d,f,g){c||(c="short"),d||(d="bottom"),f||(f=function(){}),g||(g=function(){}),e(function(){a.plugins.toast.show(b,c,d,f,g)})}function e(d){b.ready(function(){a.plugins&&a.plugins.toast?d():c.trackError("pluginNotFound:Toast")})}var f={show:d,showShortTop:function(a,b,c){d(a,"short","top",b,c)},showShortCenter:function(a,b,c){d(a,"short","center",b,c)},showShortBottom:function(a,b,c){d(a,"short","bottom",b,c)},showLongTop:function(a,b,c){d(a,"long","top",b,c)},showLongCenter:function(a,b,c){d(a,"long","center",b,c)},showLongBottom:function(a,b,c){d(a,"long","bottom",b,c)}};return f}]).factory("MediaSrv",["$q","$window","$ionicPlatform","LogSrv",function(a,b,c,d){"use strict";function e(d,e,g,h){var j=a.defer();return i(function(){var a=function(){e&&e()},i=function(a){f(d,a),g&&g(a)},k=function(a){h&&h(a)};c.is("android")&&(d="/android_asset/www/"+d),j.resolve(new b.Media(d,a,i,k))},j),j.promise}function f(a,b){d.trackError("media",{src:a,code:b.code,message:h(b.code)})}function g(a){return 0===a?"Media.MEDIA_NONE":1===a?"Media.MEDIA_STARTING":2===a?"Media.MEDIA_RUNNING":3===a?"Media.MEDIA_PAUSED":4===a?"Media.MEDIA_STOPPED":"Unknown status <"+a+">"}function h(a){return 1===a?"MediaError.MEDIA_ERR_ABORTED":2===a?"MediaError.MEDIA_ERR_NETWORK":3===a?"MediaError.MEDIA_ERR_DECODE":4===a?"MediaError.MEDIA_ERR_NONE_SUPPORTED":"Unknown code <"+a+">"}function i(a,e){c.ready(function(){b.Media?a():(d.trackError("pluginNotFound:Media"),e.reject("pluginNotFound:Media"))})}var j={loadMedia:e,getStatusMessage:g,getErrorMessage:h,loadTimerAlarm:function(a,b,c){return e("sounds/timerEnds.mp3",a,b,c)}};return j}]).factory("InsomniaSrv",["$window","$ionicPlatform","LogSrv",function(a,b,c){"use strict";function d(){f(function(){a.plugins.insomnia.keepAwake()})}function e(){f(function(){a.plugins.insomnia.allowSleepAgain()})}function f(d){b.ready(function(){a.plugins&&a.plugins.insomnia?d():c.trackError("pluginNotFound:Insomnia")})}var g={keepAwake:d,allowSleepAgain:e};return g}]).factory("AccountsSrv",["$q","$window","$ionicPlatform","PopupSrv","LogSrv",function(a,b,c,d,e){"use strict";function f(){var c=a.defer();return i(function(){b.plugins.DeviceAccounts.get(function(a){c.resolve(a)},function(a){c.reject(a)})}),c.promise}function g(){var c=a.defer();return i(function(){b.plugins.DeviceAccounts.getEmail(function(a){c.resolve(a)},function(a){c.reject(a)})}),c.promise}function h(){var c=a.defer();return i(function(){b.plugins.DeviceAccounts.getEmail(function(a){a?c.resolve(a):d.forceAskEmail().then(function(a){c.resolve(a)})},function(){d.forceAskEmail().then(function(a){c.resolve(a)})})}),c.promise}function i(a){c.ready(function(){b.plugins&&b.plugins.DeviceAccounts?a():e.trackError("pluginNotFound:DeviceAccounts")})}var j={getAccounts:f,getEmail:g,getEmailOrAsk:h};return j}]),angular.module("app").factory("Utils",["$interval",function(a){"use strict";function b(){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return(a()+a()+"-"+a()+"-4"+a().substr(0,3)+"-"+a()+"-"+a()+a()+a()).toLowerCase()}function c(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,d){a[d]&&"object"==typeof a[d]?c(a[d],b):a[d]=angular.copy(b)})}),a}function d(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}function e(a,b){return-1!==a.indexOf(b,a.length-b.length)}function f(a,b){return Math.floor(Math.random()*(b-a+1))-a}function g(a){var b={id:q++,fn:a};return o.push(b),1===o.length&&i(),b.id}function h(a){for(var b in o)o[b].id===a&&o.splice(b,1);0===o.length&&j()}function i(){null===p&&(p=a(function(){for(var a in o)o[a].fn()},1e3))}function j(){null!==p&&(a.cancel(p),p=null)}function k(){var a=angular.copy(ionic.Platform.device());return delete a.getInfo,a.environment=l(),a.grade=ionic.Platform.grade,a.platforms=ionic.Platform.platforms,a}function l(){return ionic.Platform.isWebView()?"WebView":ionic.Platform.isIPad()?"IPad":ionic.Platform.isIOS()?"IOS":ionic.Platform.isAndroid()?"Android":ionic.Platform.isWindowsPhone()?"WindowsPhone":"Unknown"}function m(){navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp()}var n={createUuid:b,extendDeep:c,isEmail:d,endsWith:e,randInt:f,clock:g,cancelClock:h,getDevice:k,exitApp:m},o=[],p=null,q=0;return n}]).factory("PopupSrv",["$rootScope","$q","$ionicPopup","$ionicActionSheet","ToastSrv","config",function(a,b,c,d,e,f){"use strict";function g(){if(f.defaultEmail)return b.when(f.defaultEmail);var d=a.$new(!0);return d.data={email:""},c.show({template:'<input type="email" placeholder="Email" ng-model="data.email">',title:'Restons en contact !<br>Lâche ton email <i class="fa fa-smile-o">',subTitle:"Aucun spam garanti !",scope:d,buttons:[{text:"<b>Continuer</b>",type:"button-positive",onTap:function(a){return d.data.email?d.data.email:(a.preventDefault(),void e.show("Please, enter you email !"))}}]})}function h(b,d){var e=a.$new(!0);return e.data={servings:b?b:2},c.show({template:['<div style="text-align: center;">'+(d?'<h3 class="title" style="font-size: 20px;">'+d+"</h3>":"")+'<div>Cuisiner pour <b ng-bind="data.servings">??</b> personnes ?</div></div><div class="range"><i class="fa fa-user"></i><input type="range" name="servings" min="1" max="10" ng-model="data.servings"><i class="fa fa-users"></i></div>'].join(""),scope:e,buttons:[{text:"Annuler"},{text:"<b>Ok</b>",type:"button-positive",onTap:function(){return e.data.servings}}]})}function i(){var a=b.defer();return d.show({titleText:"La recette est maintenant terminée ! Que faire ?",destructiveText:"Quitter l'application",destructiveButtonClicked:function(){a.resolve(!0)},cancelText:"Revenir à l'accueil",cancel:function(){a.resolve(!1)}}),a.promise}function j(){return c.show({title:"Man vs Time",subTitle:"Respecte le chrono !!!",template:['<ul style="list-style: circle;"><li style="margin: 0px 0 5px 15px;"><i>Ne brûle rien</i>, aide-toi des <b>timers</b></li><li style="margin: 0px 0 5px 15px;"><i>Ne perds pas ton temps</i> avec le téléphone, <b>l\'écran reste allumé</b></li><li style="margin: 0px 0 5px 15px;"><i>Valide ton chrono</i> en cliquant sur <b>Finir !</b></li></ul>'].join(""),buttons:[{text:"<b>Go !</b>",type:"button-custom"}]})}function k(){return c.show({title:"Liste de course",template:"<div class=\"text-align: center;\">Fais tes courses pépère,<br>l'écran ne s'éteint pas :D</div>",buttons:[{text:"<b>Ok</b>",type:"button-custom"}]})}var l={forceAskEmail:g,changeServings:h,recipeCooked:i,tourCookFeatures:j,tourCartFeatures:k};return l}]),angular.module("app").factory("PriceCalculator",["$window","LogSrv",function(a,b){"use strict";function c(a,c,d,e){var f=angular.copy(a);if(f.currency!==c.currency||a.unit||c.unit){var g={message:"Unexpected error on addPrices",p1:angular.copy(a),p2:angular.copy(c)};f.currency!==c.currency?g.message="Can't add price <"+a.currency+"> with price <"+c.currency+">":a.unit?g.message="Price p1 has unit <"+a.unit+">":c.unit&&(g.message="Price p2 has unit <"+c.unit+">"),d&&d.ingredient&&(g.ingredient=angular.copy(d.ingredient),g.message=g.message+" for ingredient <"+d.ingredient.food.name+">"),e?e.push(g):b.trackError("addIngredientsPrice",g)}else f.value+=c.value;return f}function d(a,b,d){if(Array.isArray(a)&&a.length>0){for(var e=angular.copy(a[0]),f=1;f<a.length;f++)e=c(e,a[f],b,d);return e}}function e(a,c,d){if(a.unit&&a.unit===c.unit)return{value:a.value*c.value,currency:a.currency};var e={message:"Unexpected error on PriceCalculator.getForServings",price:angular.copy(a),servings:angular.copy(c)};a.unit?a.unit!==c.unit&&(e.message="Can 't convert price with unit <"+a.unit+"> to unit <"+c.unit+">"):e.message="UnitPrice does not has unit <"+a.unit+">",d?d.push(e):b.trackError("PriceCalculator.getForServings",e)}function f(a,c,d,e){if(c.unit===d.unit){var f=angular.copy(a);return f.value=f.value*(d.value/c.value),f}var g={message:"Unexpected error on PriceCalculator.adjustForServings",price:angular.copy(a),initialServings:angular.copy(c),finalServings:angular.copy(d)};c.unit!==d.unit&&(g.message="Can 't convert servings <"+c.unit+"> to <"+d.unit+">"),e?e.push(g):b.trackError("PriceCalculator.adjustForServings",g)}var g={add:c,sum:d,getForServings:e,adjustForServings:f};return g}]),angular.module("app").factory("QuantityCalculator",["$window","LogSrv",function(a,b){"use strict";function c(a,c,d,e){var f=angular.copy(a);if(f.unit===c.unit)f.value+=c.value;else{var g={message:"Can't add quantity <"+a.unit+"> with quantity <"+c.unit+">"+(d&&d.ingredient?" for ingredient <"+d.ingredient.food.name+">":"")+" !"};d&&d.ingredient&&(g.ingredient=angular.copy(d.ingredient)),e?e.push(g):b.trackError("addIngredientsQuantity",g)}return f}function d(a,b,d){if(Array.isArray(a)&&a.length>0){for(var e=angular.copy(a[0]),f=1;f<a.length;f++)e=c(e,a[f],b,d);return e}}function e(a,c,d,e){if(c.unit===d.unit){var f=angular.copy(a);return f.value=f.value*(d.value/c.value),f}var g={message:"Unexpected error on QuantityCalculator.adjustForServings",quantity:angular.copy(a),initialServings:angular.copy(c),finalServings:angular.copy(d)};c.unit!==d.unit&&(g.message="Can 't convert servings <"+c.unit+"> to <"+d.unit+">"),e?e.push(g):b.trackError("QuantityCalculator.adjustForServings",g)}var f={add:c,sum:d,adjustForServings:e};return f}]),angular.module("app").factory("LogSrv",["$timeout","Utils","_LocalStorageSrv",function(a,b,c){"use strict";function d(b,c){if(navigator&&navigator.geolocation){var d=Date.now(),f=a(function(){e(b,c,d)},3e3);navigator.geolocation.getCurrentPosition(function(g){a.cancel(f),c.position=g.coords,c.position&&(c.position.timestamp=g.timestamp),e(b,c,d)},function(g){a.cancel(f),c.position=g,c.position&&(c.position.timestamp=Date.now()),e(b,c,d)},{enableHighAccuracy:!0,timeout:2e3,maximumAge:0})}else e(b,c)}function e(a,b,d){var e=c.getUser(),f={};b&&(f.data=b),d&&(f.time=d),e&&e.id&&(f.userId=e.id),e&&e.device&&(f.source={},f.source.device=angular.copy(e.device)),Logger.track(a,f)}var f={trackInstall:function(){e("app-installed")},trackUpgrade:function(a,b){e("app-upgraded",{from:a,to:b})},trackLaunch:function(a){e("app-launched",{launchTime:a})},trackShowRecipeIngredients:function(a,b){e("recipe-ingredients-showed",{recipe:a,index:b})},trackShowRecipeDetails:function(a,b){e("recipe-details-showed",{recipe:a,index:b})},trackAddRecipeToCart:function(a,b,c){e("recipe-added-to-cart",{recipe:a,servings:b,index:c})},trackRemoveRecipeFromCart:function(a,b){e("recipe-removed-from-cart",{recipe:a,index:b})},trackShowRecipeCook:function(a){e("recipe-cook-showed",{recipe:a})},trackRecipeCooked:function(a,b){e("recipe-cooked",{recipe:a,cookDuration:b})},trackRecipesFeedback:function(a,b){e("recipes-feedback-sent",{week:a,feedback:b})},trackBuyItem:function(a,b){d("item-bought",{item:a,quantity:b})},trackUnbuyItem:function(a){e("item-unbought",{item:a})},trackEditCartCustomItems:function(a){e("cart-custom-items-edited",{customItems:a})},trackCartRecipeDetails:function(a){e("cart-recipe-details-showed",{recipe:a})},trackShowCartItemDetails:function(a){e("cart-item-details-showed",{item:a})},trackClearCache:function(){e("cache-cleared")},trackClearApp:function(){e("app-cleared")},trackOpenUservoice:function(){e("uservoice-opened")},trackError:function(a,b){e("error",{type:a,error:b})}};return f}]),angular.module("app").factory("StorageSrv",["$window","$state","$q","_LocalStorageSrv","BackendUserSrv","AccountsSrv","Utils","LogSrv","localStorageDefault",function(a,b,c,d,e,f,g,h,i){"use strict";function j(a){var b=d.getUser();return b?b.settings[a]:null}function k(a,b){var f=d.getUser();return f&&f.settings?(f.settings[a]=b,d.setUser(f),e.updateUserSetting(f.id,a,b)):(f||(f={}),f.settings={},f.settings[a]=b,d.setUser(f),c.when())}var l={getApp:d.getApp,getUser:d.getUser,getUserSetting:j,saveUser:d.setUser,saveUserSetting:k,getFood:function(a){return d.getFoods().foods[a]},addFood:function(a){if(a&&a.id){var b=d.getFoods();b.foods[a.id]=a,d.setFoods(b)}},getRecipe:function(a){return d.getRecipes().recipes[a]},addRecipe:function(a){if(a&&a.id){var b=d.getRecipes();b.recipes[a.id]=a,d.setRecipes(b)}},getSelection:function(a){return d.getSelections().selections[a]},addSelection:function(a){if(a&&a.id){var b=d.getSelections();b.selections[a.id]=a,d.setSelections(b)}},getRecipeHistory:function(){var a=d.getRecipeHistory();return a?a.recipes:null},addRecipeToHistory:function(a){if(a&&a.id){var b=d.getRecipeHistory();_.remove(b.recipes,{id:a.id}),b.recipes.unshift(a),d.setRecipeHistory(b)}},getCarts:function(){return d.getCarts().carts},saveCart:function(a){d.updateCarts("carts",a)},addCart:function(a){var b=d.getCarts();b.carts.unshift(a),d.setCarts(b)},getStandaloneCookedRecipes:function(){return d.getStandaloneCookedRecipes().recipes},addStandaloneCookedRecipe:function(a){var b=d.getStandaloneCookedRecipes();b.recipes.push(a),d.setStandaloneCookedRecipes(b)},getGlobalMessages:function(){return d.getGlobalmessages()},clearCache:function(){d.setFoods(i.dataFoods),d.setRecipes(i.dataRecipes),d.setSelections(i.dataSelections)},clear:function(){d.reset()}};return l}]).factory("_LocalStorageSrv",["$window","config",function(a,b){"use strict";function c(c){return!h[c]&&a.localStorage&&b.storage&&(h[c]=JSON.parse(a.localStorage.getItem(i+c))),angular.copy(h[c])}function d(c,d){angular.equals(h[c],d)?console.debug("Don't save <"+c+"> because values are equals !"):(h[c]=angular.copy(d),a.localStorage&&b.storage&&a.localStorage.setItem(i+c,JSON.stringify(h[c])))}function e(a,b,e){if(e&&e.id){var g=c(a);f(g[b],e),d(a,g)}}function f(a,b){if(Array.isArray(a)){var c=_.findIndex(a,{id:b.id});c>-1&&a.splice(c,1,b)}}function g(){if(a.localStorage&&b.storage){h={};for(var c in a.localStorage)a.localStorage.removeItem(c)}}var h={},i="ionic-",j={getApp:function(){return c("app")},setApp:function(a){return d("app",a)},getUser:function(){return c("user")},setUser:function(a){return d("user",a)},getFoods:function(){return c("dataFoods")},setFoods:function(a){return d("dataFoods",a)},getRecipes:function(){return c("dataRecipes")},setRecipes:function(a){return d("dataRecipes",a)},getSelections:function(){return c("dataSelections")},setSelections:function(a){return d("dataSelections",a)},getRecipeHistory:function(){return c("userRecipeHistory")},setRecipeHistory:function(a){return d("userRecipeHistory",a)},getCarts:function(){return c("userCarts")},setCarts:function(a){return d("userCarts",a)},updateCarts:function(a,b){return e("userCarts",a,b)},getStandaloneCookedRecipes:function(){return c("userStandaloneCookedRecipes")},setStandaloneCookedRecipes:function(a){return d("userStandaloneCookedRecipes",a)},getGlobalmessages:function(){return c("dataGlobalmessages")},setGlobalmessages:function(a){return d("dataGlobalmessages",a)},get:c,set:d,reset:g};return j}]),angular.module("app").factory("BackendUserSrv",["$q","$http","LogSrv","firebaseUrl","Config","_LocalStorageSrv",function(a,b,c,d,e,f){"use strict";function g(a){return b.get(e.backendUrl+"/api/v1/users/"+a).then(function(a){return a.data})}function h(a){var c=f.getUser(),d=c&&c.data&&c.data.welcomeMailSent?c.data.welcomeMailSent:!1,g=d?"&welcomeEmailSent="+d:"";return b.get(e.backendUrl+"/api/v1/users/find?email="+a+g).then(function(a){return a.data})}function i(a,c,d){return b.put(e.backendUrl+"/api/v1/users/"+a+"/settings/"+c,{value:d})}function j(a,c){return b.put(e.backendUrl+"/api/v1/users/"+a+"/device",c)}var k={getUser:g,findUser:h,updateUserSetting:i,setUserDevice:j};return k}]).factory("BackendSrv",["$q","$http","StorageSrv","firebaseUrl",function(a,b,c,d){"use strict";function e(e){var f=c.getRecipe(e);return f?a.when(f):b.get(d+"/recipes/"+e+".json").then(function(a){var b=a.data;if(b&&b.ingredients)for(var d in b.ingredients){var e=b.ingredients[d];if(e&&e.food&&e.food.category&&"string"==typeof e.food.category){var f=_.find(j,{name:e.food.category});e.food.category=f?angular.copy(f):{id:15,order:15,name:e.food.category,slug:getSlug(e.food.category)}}}return c.addRecipe(b),b})}function f(e){var f=c.getSelection(e);return f?a.when(f):b.get(d+"/selections/"+e+".json").then(function(a){return g(a.data)}).then(function(a){return c.addSelection(a),a})}function g(b){if(b&&b.recipes){var c=[];for(var d in b.recipes)c.push(e(b.recipes[d].id));return a.all(c).then(function(a){return b.recipes=a,b})}return a.when(b)}function h(){return b.get(d+"/globalmessages.json").then(function(a){return a.data})}var i={getRecipe:e,getSelection:f,getMessages:h},j=[{id:1,order:1,name:"Fruits & Légumes"},{id:2,order:2,name:"Viandes & Poissons"},{id:3,order:3,name:"Frais"},{id:4,order:4,name:"Pains & Pâtisseries"},{id:5,order:5,name:"Épicerie salée"},{id:6,order:6,name:"Épicerie sucrée"},{id:7,order:7,name:"Boissons"},{id:8,order:8,name:"Bio"},{id:9,order:9,name:"Bébé"},{id:10,order:10,name:"Hygiène & Beauté"},{id:11,order:11,name:"Entretien & Nettoyage"},{id:12,order:12,name:"Animalerie"},{id:13,order:13,name:"Bazar & Textile"},{id:14,order:14,name:"Surgelés"}];for(var k in j)j[k].slug=getSlug(j[k].name);return i}]),angular.module("app").factory("LaunchSrv",["$rootScope","$state","$q","$ionicPlatform","$ionicLoading","StorageSrv","BackendUserSrv","AccountsSrv","ToastSrv","InsomniaSrv","LogSrv","Utils","_LocalStorageSrv","localStorageDefault","Config",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";function p(a){var b=c.defer();return h.getEmailOrAsk().then(function(c){var d=g.findUser(c).then(function(a){f.saveUser(a),g.setUserDevice(a.id,l.getDevice())},function(a){a?"string"==typeof a&&(a={message:a}):a={},k.trackError("userNotFound",a),f.saveUser({email:c,settings:{}})});d["finally"](function(){a?k.trackUpgrade(a,o.appVersion):k.trackInstall(),q().then(function(){b.resolve()})})}),b.promise}function q(){return s(),t(),u(),v(),w(),c.when()}function r(){var a=m.getApp();if(!a||a.version!==o.appVersion){for(var b in n){var c=b,d=n[c]||{},e=m.get(c)||{},f=l.extendDeep({},d,e);m.set(c,f)}a=m.getApp(),""!==a.version&&m.setUser({upgrade:a.version,data:{welcomeMailSent:!0}}),a=m.getApp(),a.version=o.appVersion,m.setApp(a)}}function s(){var a=Date.now()-INIT;o.debug&&ionic.Platform.isWebView()&&i.show("Application started in "+a+" ms"),k.trackLaunch(a)}function t(){var a=f.getUser();a&&a.email&&g.findUser(a.email).then(function(a){f.saveUser(a)})}function u(){a.$on("$stateChangeError",function(a,b,c,d,e,f){var g={};d&&d.name&&(g.from=d.name),e&&!x(e)&&(g.fromParams=e),b&&b.name&&(g.to=b.name),c&&!x(c)&&(g.toParams=c),f&&!x(f)&&(g.error=f),k.trackError("stateChangeError",g)}),a.$on("$stateNotFound",function(a,b,c,d){var e={};c&&c.name&&(e.from=c.name),d&&!x(d)&&(e.fromParams=d),b&&b.to&&(e.to=b.to),b&&b.toParams&&!x(b.toParams)&&(e.toParams=b.toParams),k.trackError("stateNotFound",e)})}function v(){a.$on("$stateChangeSuccess",function(a,b){b&&b.data&&b.data.noSleep?j.keepAwake():j.allowSleepAgain()})}function w(){a.$on("$stateChangeStart",function(){e.show()}),a.$on("$stateChangeSuccess",function(){e.hide()})}function x(a){return 0===Object.keys(a).length}var y={launch:function(){var a=c.defer();r();var b=f.getUser();return b&&b.id?q().then(function(){a.resolve()}):p(b?b.upgrade:null).then(function(){a.resolve()}),a.promise}};return y}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.cart",{url:"/cart","abstract":!0,views:{menuContent:{templateUrl:"scripts/cart/cart.html",controller:"CartCtrl"}}}).state("app.cart.recipes",{url:"/recipes",templateUrl:"scripts/cart/cart-recipes.html",controller:"CartRecipesCtrl"}).state("app.cart.ingredients",{url:"/ingredients",templateUrl:"scripts/cart/cart-ingredients.html",controller:"CartIngredientsCtrl",data:{noSleep:!0}})}]).controller("CartCtrl",["$scope","$state","$ionicPopover","$window","CartSrv",function(a,b,c,d,e){"use strict";function f(a){return!(a&&(a.recipes&&a.recipes.length>0||a.customItems&&a.customItems.length>0))}a.cart=e.hasOpenedCarts()?e.getOpenedCarts()[0]:e.createCart(),a.cart.$formated||(a.cart.$formated={}),a.cart.$formated.isEmpty=f(a.cart),c.fromTemplateUrl("scripts/cart/cart-popover.html",{scope:a}).then(function(b){a.popover=b}),a.archiveCart=function(){d.confirm("Archiver cette liste ?")&&(e.archive(a.cart),a.popover.remove(),b.go("app.home"))}}]).controller("CartRecipesCtrl",["$scope","CartSrv","StorageSrv","ToastSrv","LogSrv",function(a,b,c,d,e){"use strict";a.selectedRecipe=null,a.totalPrice=b.getPrice(a.cart),a.toggleRecipe=function(b){a.selectedRecipe===b?a.selectedRecipe=null:(e.trackCartRecipeDetails(b.id),a.selectedRecipe=b)},a.removeRecipeFromCart=function(c){e.trackRemoveRecipeFromCart(c.id,null,"cart"),b.removeRecipe(a.cart,c),d.show("✔ recette supprimée de la liste de courses")},a.updateServings=function(){c.saveCart(a.cart),a.totalPrice=b.getPrice(a.cart)}}]).controller("CartIngredientsCtrl",["$scope","CartSrv","StorageSrv","PopupSrv","ToastSrv","LogSrv","Utils",function(a,b,c,d,e,f,g){"use strict";function h(a){return"string"==typeof a?_.filter(_.map(a.split("\n"),function(a){var b=a.trim();return b.length>0?g.endsWith(b," ok")?{bought:!0,name:b.replace(/ ok/g,"")}:{bought:!1,name:b}:void 0}),function(a){return a&&a.name&&a.name.length>0}):Array.isArray(a)?angular.copy(a.trim()):void f.trackError("cartCustomItemsError",{message:"Can't parse customItems",customItems:angular.copy(a)})}function i(a){var b="";return"string"==typeof a?b=angular.copy(a.trim()):Array.isArray(a)?b=_.map(a,function(a){return a.name+(a.bought?" ok":"")}).join("\n"):f.trackError("cartCustomItemsError",{message:"Can't parse customItems",customItems:angular.copy(a)}),""!==b&&(b+="\n"),b}a.totalPrice=b.getPrice(a.cart);var j=c.getUser();j&&j.settings&&j.settings.skipCartFeatures||d.tourCartFeatures().then(function(){c.saveUserSetting("skipCartFeatures",!0)}),Array.isArray(a.cart.customItems)||(a.cart.customItems=h(a.cart.customItems),c.saveCart(a.cart)),a.customItems=a.cart.customItems,a.items=b.getItems(a.cart),a.editingCustomItems=!1,a.customItemsText="",a.editCustomItems=function(){a.editingCustomItems||(a.editingCustomItems=!0,a.customItemsText=i(a.cart.customItems))},a.cancelCustomItems=function(){a.editingCustomItems&&(a.editingCustomItems=!1,a.customItemsText="")},a.saveCustomItems=function(){a.editingCustomItems&&(a.editingCustomItems=!1,a.cart.customItems=h(a.customItemsText),a.customItems=a.cart.customItems,c.saveCart(a.cart),a.customItemsText="",f.trackEditCartCustomItems(a.cart.customItems))},a.buyCustomItem=function(b){b.bought=!0,c.saveCart(a.cart),e.show("✔ "+b.name+" acheté !")},a.unbuyCustomItem=function(b){b.bought=!1,c.saveCart(a.cart)},a.openedItems=[],a.isOpened=function(b){return _.findIndex(a.openedItems,{food:{id:b.food.id}})>-1},a.toggleItem=function(b){var c=_.findIndex(a.openedItems,{food:{id:b.food.id}});c>-1?a.openedItems.splice(c,1):(a.openedItems.push(b),f.trackShowCartItemDetails(b.food.id))},a.cartHasItems=function(){return a.items.length>0||a.customItems.length>0},a.cartHasItemsToBuy=function(){var b=_.filter(a.items,function(b){return!a.isBought(b)});return b.length>0},a.cartHasCustomItemsToBuy=function(){var b=_.filter(a.customItems,function(a){return!a.bought});return b.length>0},a.isBought=function(a){var b=!0;return angular.forEach(a.sources,function(a){a.ingredient.bought||(b=!1)}),b},a.buyItem=function(c){f.trackBuyItem(c.food.id,c.quantity),b.buyItem(a.cart,c),e.show("✔ "+c.food.name+" acheté !")
},a.unbuyItem=function(c){f.trackUnbuyItem(c.food.id),b.unbuyItem(a.cart,c)}}]).factory("CartSrv",["StorageSrv","PriceCalculator","_CartBuilder","_CartUtils",function(a,b,c,d){"use strict";function e(){return _.findIndex(a.getCarts(),{archived:!1})>-1}function f(){return _.filter(a.getCarts(),{archived:!1})}function g(b){return _.find(a.getCarts(),{id:b})}function h(a,b){return a?_.find(a.recipes,{id:b}):null}function i(a,b){var c=g(a);return h(c,b)}function j(b){var d=c.createCart(b);return a.addCart(d),d}function k(b){a.saveCart(b)}function l(a){if(a&&a.cartData&&a.cartData.cart){var b=g(a.cartData.cart),c=h(b,a.id);c&&(angular.copy(a,c),k(b))}}function m(){return x(f())}function n(){var a=m();return d.recipesToItems(a)}function o(b){var c=x(a.getCarts()),d=_.filter(c,{cartData:{cooked:!1}});return b&&"function"==typeof b&&d&&Array.isArray(d)&&d.sort(b),d}function p(b){var c=x(a.getCarts()),d=_.filter(c,function(a){return a&&a.cartData&&a.cartData.cooked&&"none"!==a.cartData.cooked&&a.cartData.cooked!==!1}),e=a.getStandaloneCookedRecipes(),f=d.concat(e);return b&&"function"==typeof b&&f&&Array.isArray(f)&&f.sort(b),f}function q(a){if(a&&a.recipes&&Array.isArray(a.recipes)){for(var c=null,d=0;d<a.recipes.length;d++){var e=a.recipes[d],f=b.getForServings(e.price,e.cartData.servings);c=0===d?f:b.add(c,f)}return c}}function r(a){return d.recipesToItems(a.recipes)}function s(a,b){return _.findIndex(a.recipes,{id:b.id})>-1}function t(b,d,e){var f=c.createRecipe(b,d,e);b.recipes.push(f),a.saveCart(b)}function u(b,c){_.remove(b.recipes,{id:c.id}),a.saveCart(b)}function v(b,c,e){_.map(c.sources,function(a){a.ingredient.bought=e});for(var f in c.sources){var g=c.sources[f].recipe;g.cartData.boughtPc=d.boughtPercentage(g)}a.saveCart(b)}function w(b){b.archived=!0,a.saveCart(b)}function x(a){return _.reduce(a,function(a,b){return a.concat(b.recipes)},[])}var y={getCarts:a.getCarts,hasOpenedCarts:e,getOpenedCarts:f,getCart:g,getRecipeFromCart:h,getCartRecipe:i,createCart:j,updateCart:k,updateCartRecipe:l,recipesFromOpenedCarts:m,itemsFromOpenedCarts:n,getRecipesToCook:o,getCookedRecipes:p,addStandaloneCookedRecipe:a.addStandaloneCookedRecipe,getPrice:q,getItems:r,hasRecipe:s,addRecipe:t,removeRecipe:u,buyItem:function(a,b){v(a,b,!0)},unbuyItem:function(a,b){v(a,b,!1)},archive:w};return y}]).factory("_CartUtils",["_CartBuilder",function(a){"use strict";function b(b){var c=[];return _.map(b,function(b){_.map(b.ingredients,function(d){var e=_.find(c,{food:{id:d.food.id}});e?a.addSourceToItem(e,d,b):c.push(a.createItem(d,b))})}),d(c),c}function c(a){if(a&&a.cartData&&a.ingredients&&a.ingredients.length>0){var b=0;for(var c in a.ingredients)a.ingredients[c].bought&&b++;return 100*b/a.ingredients.length}return 100}function d(a){a.sort(function(a,b){var c=a&&a.food&&a.food.category&&a.food.category.order?a.food.category.order:50,d=b&&b.food&&b.food.category&&b.food.category.order?b.food.category.order:50,e=a&&a.name?a.name.toLowerCase():"",f=b&&b.name?b.name.toLowerCase():"";return c>d?1:d>c?-1:e>f?1:f>e?-1:0})}var e={recipesToItems:b,boughtPercentage:c};return e}]).factory("_CartBuilder",["PriceCalculator","QuantityCalculator","Utils",function(a,b,c){"use strict";function d(a){return{id:c.createUuid(),created:Date.now(),archived:!1,name:a?a:"Liste du "+moment().format("LL"),recipes:[],customItems:[]}}function e(a,b,c){var d=angular.copy(b);return d.cartData={cart:a.id,created:Date.now(),boughtPc:0,cooked:!1,servings:{value:c,unit:b.servings.unit}},d}function f(a,b){var c=angular.copy(a),d=h(a,b);return c.price=d.price,c.quantity=d.quantity,c.sources=[d],c}function g(c,d,e){var f=h(d,e);c.sources.push(f);var g={ingredient:c};c.price=a.sum(_.map(c.sources,"price"),g),c.quantity=b.sum(_.map(c.sources,"quantity"),g)}function h(c,d){return{price:a.adjustForServings(c.price,d.servings,d.cartData.servings),quantity:b.adjustForServings(c.quantity,d.servings,d.cartData.servings),ingredient:c,recipe:d}}var i={createCart:d,createRecipe:e,createItem:f,addSourceToItem:g};return i}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.recipes",{url:"/recipes",views:{menuContent:{templateUrl:"scripts/recipe/recipes.html",controller:"RecipesCtrl"}}}).state("app.recipe",{url:"/recipe/:recipeId?recipeIndex",views:{menuContent:{templateUrl:"scripts/recipe/recipe.html",controller:"RecipeCtrl"}}}).state("app.cook",{url:"/cook/:cartId/:recipeId",views:{menuContent:{templateUrl:"scripts/recipe/cook.html",controller:"CookCtrl"}},data:{noSleep:!0}}).state("app.tocook",{url:"/tocook",views:{menuContent:{templateUrl:"scripts/recipe/tocook.html",controller:"TocookCtrl"}}}).state("app.cooked",{url:"/cooked",views:{menuContent:{templateUrl:"scripts/recipe/cooked.html",controller:"CookedCtrl"}}})}]).controller("RecipesCtrl",["$rootScope","$scope","$state","PopupSrv","SelectionSrv","StorageSrv","CartSrv","ToastSrv","LogSrv",function(a,b,c,d,e,f,g,h,i){"use strict";function j(a,b){if(Array.isArray(a))for(var c=0;b>c;c++)a.push(a.shift())}b.loadSelection=function(){b.status="loading",e.getCurrent().then(function(a){if(a&&a.recipes){for(var c in a.recipes){var d=a.recipes[c];d.$formated||(d.$formated={}),d.$formated.isInCart=g.hasRecipe(k,d)}j(a.recipes,f.getUserSetting("recipeShiftOffset"))}b.selection=a,b.status="loaded"},function(){b.status="error"})},b.loadSelection(),b.recipeShowIngredients=null;var k=g.hasOpenedCarts()?g.getOpenedCarts()[0]:g.createCart();b.toggleIngredients=function(a,c){b.recipeShowIngredients===a?b.recipeShowIngredients=null:(b.recipeShowIngredients=a,i.trackShowRecipeIngredients(a.id,c))},b.addRecipeToCart=function(b,c){d.changeServings(a.ctx.settings.defaultServings,b.name).then(function(d){d&&(d=parseInt(d),i.trackAddRecipeToCart(b.id,d,c),a.ctx.settings.defaultServings=d,f.saveUserSetting("defaultServings",d),g.addRecipe(k,b,d),b.$formated.isInCart=!0,h.show("✔ recette ajoutée à la liste de courses"),f.addRecipeToHistory(b))})},b.removeRecipeFromCart=function(a,b){i.trackRemoveRecipeFromCart(a.id,b),g.removeRecipe(k,a),a.$formated.isInCart=!1,h.show("✔ recette supprimée de la liste de courses")},b.recipeFeedback=function(a){i.trackRecipesFeedback(b.selection.week,a),c.go("app.feedback",{source:"recipes-rating-"+a})}}]).controller("RecipeCtrl",["$rootScope","$scope","$stateParams","CartSrv","StorageSrv","BackendSrv","PopupSrv","ToastSrv","LogSrv",function(a,b,c,d,e,f,g,h,i){"use strict";var j=c.recipeId,k=c.recipeIndex?parseInt(c.recipeIndex):void 0,l=d.hasOpenedCarts()?d.getOpenedCarts()[0]:d.createCart();i.trackShowRecipeDetails(j,k),f.getRecipe(j).then(function(a){e.addRecipeToHistory(a),a.$formated||(a.$formated={}),a.$formated.isInCart=d.hasRecipe(l,a),b.recipe=a}),b.addRecipeToCart=function(b){g.changeServings(a.ctx.settings.defaultServings,b.name).then(function(c){c&&(c=parseInt(c),i.trackAddRecipeToCart(b.id,c,k),a.ctx.settings.defaultServings=c,e.saveUserSetting("defaultServings",c),d.addRecipe(l,b,c),b.$formated.isInCart=!0,h.show("✔ recette ajoutée à la liste de courses"))})},b.removeRecipeFromCart=function(a){i.trackRemoveRecipeFromCart(a.id,k),d.removeRecipe(l,a),a.$formated.isInCart=!1,h.show("✔ recette supprimée de la liste de courses")}}]).controller("CookCtrl",["$scope","$state","$stateParams","$window","CartSrv","StorageSrv","BackendSrv","PopupSrv","ToastSrv","LogSrv","Utils",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(b){if(b){a.recipe=b,f.addRecipeToHistory(a.recipe),a.servings=a.recipe.cartData?a.recipe.cartData.servings.value:a.recipe.servings.value,a.servingsAdjust=a.servings/a.recipe.servings.value,a.timer=moment.duration(a.recipe.time.eat,"minutes").asSeconds();var c=f.getUser();c&&c.settings&&c.settings.skipCookFeatures?n():h.tourCookFeatures().then(function(){f.saveUserSetting("skipCookFeatures",!0),n()})}else j.trackError("notFoundCookRecipe",{message:"Unable to find cook recipe !",cartId:q,recipeId:r}),d.alert("Error: forbidden action !\nCan't cook recipe from "+q+"/"+r+" !\nPlease contact loicknuchel@gmail.com !")}function m(a,b,c,d){if(b&&b.cartData)b.cartData.cooked={time:Date.now(),duration:d},e.updateCartRecipe(b);else{var f=angular.copy(b);f.cartData={cooked:{time:Date.now(),duration:d},servings:{value:c,unit:f.servings.unit}},e.addStandaloneCookedRecipe(f)}}function n(){p=Date.now(),s=k.clock(function(){a.timer--}),a.$on("$destroy",function(){o()})}function o(){null!==s&&(k.cancelClock(s),s=null)}var p,q=c.cartId,r=c.recipeId,s=null;a.timer=0,j.trackShowRecipeCook(r),"none"===q?g.getRecipe(r).then(function(a){l(a)}):l(e.getCartRecipe(q,r)),a.changeServings=function(){h.changeServings(a.servings).then(function(b){b&&(b=parseInt(b),a.servings=b,a.servingsAdjust=a.servings/a.recipe.servings.value)})},a.done=function(){o();var c=60,e=(Date.now()-p)/1e3;c>e?(d.history.back(),i.show("T'as pas cuisiné, avoue ! ;)")):(j.trackRecipeCooked(a.recipe.id,e),m(q,a.recipe,a.servings,e),h.recipeCooked().then(function(a){a?k.exitApp():b.go("app.home")}))},a.$on("$destroy",function(){o()})}]).controller("TocookCtrl",["$scope","$window","PopupSrv","CartSrv",function(a,b,c,d){"use strict";a.recipes=d.getRecipesToCook(function(a,b){var c=-(a.cartData.boughtPc-b.cartData.boughtPc);return 0===c?-(a.cartData.created-b.cartData.created):c}),a.changeServings=function(b){c.changeServings(a.servings).then(function(a){a&&(a=parseInt(a),b.cartData.servings.value=a,d.updateCartRecipe(b))})},a.remove=function(c){b.confirm("Ne plus cuisiner cette recette ?")&&(c.cartData.cooked="none",d.updateCartRecipe(c),a.recipes.splice(a.recipes.indexOf(c),1))}}]).controller("CookedCtrl",["$scope","CartSrv",function(a,b){"use strict";a.recipes=b.getCookedRecipes(function(a,b){return-(a.cartData.cooked.time-b.cartData.cooked.time)})}]).factory("SelectionSrv",["StorageSrv","BackendSrv","Config",function(a,b,c){"use strict";var d={getCurrent:function(){return b.getSelection(moment().week()+(c.debug?1:0))}};return d}]).directive("recipeImage",["imagesPlaceholders",function(a){"use strict";return{restrict:"E",template:'<img class="portrait" ng-src="{{bigImg}}" loading-src="{{bigImgFail}}" fallback-src="{{bigImgFail}}"><img class="landing" ng-src="{{smallImg}}" loading-src="{{smallImgFail}}" fallback-src="{{smallImgFail}}">',scope:{images:"="},link:function(b){b.bigImgFail=a.recipe.portrait,b.smallImgFail=a.recipe.landing,b.bigImg=b.images?b.images.portrait:b.bigImgFail,b.smallImg=b.images?b.images.landing:b.smallImgFail}}}]).directive("imgRecipe",["imagesPlaceholders",function(a){"use strict";return{restrict:"E",replace:!0,template:'<img ng-src="{{img}}" loading-src="{{imgFail}}" fallback-src="{{imgFail}}">',scope:{images:"=",type:"@"},link:function(b){b.imgFail=a.recipe[b.type],b.img=b.images?b.images[b.type]:b.imgFail,b.$watch("images",function(){b.img=b.images?b.images[b.type]:b.imgFail})}}}]).directive("cookTimer",["$timeout","$ionicScrollDelegate","MediaSrv","Utils",function(a,b,c,d){"use strict";function e(a){return a.pData?angular.copy(a.pData):a.pSteps?{color:a.pColor,label:a.pLabel,steps:angular.copy(a.pSteps)}:{color:a.pColor,label:a.pLabel,seconds:a.pSeconds}}var f=60;return{restrict:"E",templateUrl:"scripts/recipe/timer.html",scope:{pData:"=data",pColor:"=color",pLabel:"=label",pSeconds:"=seconds",pSteps:"=steps"},link:function(g){function h(){s.scroll=r.getScrollPosition(),s.clock=d.clock(function(){if(s.duration-g.time>0){if(g.time++,s.duration===g.time+f/2)p();else if(s.duration===g.time)q();else if(s.steps)for(var a in s.steps)s.steps[a].time===g.time+f/2&&n(s.steps[a]),s.steps[a].time===g.time&&o(s.steps[a])}else i()})}function i(){d.cancelClock(s.clock),s.clock=null}function j(){s.alarm===!1&&(s.alarm=!0,s.media.play(),r.scrollTo(s.scroll.left,s.scroll.top,!0))}function k(){s.alarm===!0&&s.media.play()}function l(){s.alarm===!0&&(s.alarm=!1,s.media.stop(),s.media.release())}function m(){s&&s.media&&(s.media.play(),a(function(){s.media.stop()},1200),s.scroll&&r.scrollTo(s.scroll.left,s.scroll.top,!0))}function n(){}function o(){m()}function p(){}function q(){j()}var r=b.$getByHandle("cookScroll"),s=e(g);if(s.duration=null,s.clock=null,s.alarm=!1,s.media=null,s.scroll=null,g.timer=s,c.loadTimerAlarm(k).then(function(a){s.media=a}),g.time=0,s.steps&&s.steps.length>0){var t=s.steps[s.steps.length-1];s.duration=t.time?t.time:0}else s.duration=s.seconds?s.seconds:0;g.isSelected=function(a){return a.time-f/2<=g.time&&g.time<a.time+f/2},g.isUnselected=function(a){return g.time>=a.time+f/2},g.timerClick=function(){s.alarm===!0?l():null!==s.clock?i():h()},g.$on("$destroy",function(){i(),l()})}}}]),angular.module("app").config(["$stateProvider",function(a){"use strict";a.state("app.profile",{url:"/profile",views:{menuContent:{templateUrl:"scripts/user/profile.html",controller:"ProfileCtrl"}}}).state("app.feedback",{url:"/feedback?source",views:{menuContent:{templateUrl:"scripts/user/feedback.html",controller:"FeedbackCtrl"}}})}]).controller("ProfileCtrl",["$scope","$window","StorageSrv","LogSrv","Utils",function(a,b,c,d,e){"use strict";c.getUser();a.clearCache=function(){b.confirm("Vider le cache ?")&&(d.trackClearCache(),c.clearCache())},a.resetApp=function(){b.confirm("Réinitialiser complètement l'application ?")&&(d.trackClearApp(),c.clear(),e.exitApp())},a.$watch("ctx.settings.showPrices",function(a,b){a!==b&&c.saveUserSetting("showPrices",a)}),a.$watch("ctx.settings.bigImages",function(a,b){a!==b&&c.saveUserSetting("bigImages",a)})}]).controller("FeedbackCtrl",["$scope","$stateParams","$window","StorageSrv","EmailSrv","LogSrv","supportTeamEmail",function(a,b,c,d,e,f,g){"use strict";var h=(d.getApp(),d.getUser());a.feedback={email:h.email,content:"",sending:!1,sent:!1},b.source&&("recipes-rating-1"===b.source?a.feedback.content="Bof bof bof... Tiens quelques conseils !\n\nJe serais plus fan de ...":"recipes-rating-2"===b.source?a.feedback.content="Plutôt cool tes recettes !\n\nJe verrais bien un peu plus ... ou un peu moins de ...":"recipes-rating-3"===b.source&&(a.feedback.content="Wahou c'est top !\n\nEt ça serait encore mieux si tu pouvais ...")),a.sendFeedback=function(){a.feedback.sending=!0,e.sendFeedback(a.feedback.email,a.feedback.content).then(function(b){a.feedback.sending=!1,b?a.feedback.sent=!0:c.alert("Echec de l'envoi du email :(\nContactez "+g+" si vous le souhaitez !")})},a.openUservoice=function(){f.trackOpenUservoice()},UserVoice.push(["set",{accent_color:"#f62",trigger_color:"white",trigger_background_color:"#f62"}]);var i={};h&&h.id&&(i.id=h.id),h&&h.email&&(i.email=h.email),h&&h.name&&(i.name=h.name),UserVoice.push(["identify",i]),UserVoice.push(["addTrigger","#uservoice",{mode:"smartvote"}]),UserVoice.push(["autoprompt",{}])}]);